@startuml atomic_settlement
!include <C4/C4_Component>

skinparam dpi 400
skinparam wrapWidth 300
skinparam defaultFontSize 14

' Modern professional color scheme
skinparam BackgroundColor #FAFAFA
skinparam ComponentBackgroundColor #FFFFFF
skinparam ComponentBorderColor #6366F1
skinparam ComponentFontColor #1F2937
skinparam ComponentBorderThickness 2
skinparam DatabaseBackgroundColor #F3F4F6
skinparam DatabaseBorderColor #8B5CF6
skinparam DatabaseFontColor #1F2937
skinparam SystemBackgroundColor #EEF2FF
skinparam SystemBorderColor #6366F1
skinparam SystemFontColor #1F2937
skinparam NoteBackgroundColor #FEF3C7
skinparam NoteBorderColor #F59E0B
skinparam NoteFontColor #92400E
skinparam BoundaryBackgroundColor #F9FAFB
skinparam BoundaryBorderColor #9CA3AF
skinparam BoundaryBorderStyle dashed

LAYOUT_TOP_DOWN()

System(buyer, "Buyer", "Holds THBS")
System(seller, "Seller", "Holds GRX (Energy)")

Container_Boundary(escrow, "Escrow & Settlement") {
    ContainerDb(buyer_escrow, "Buyer Escrow", "Lock THBS")
    
    Component(settlement, "Settlement", "Smart Contract")
    
    ContainerDb(seller_escrow, "Seller Escrow", "Lock GRX")
}

System_Ext(fee_pool, "Fee Pool", "Platform Fees")

' Step 1: Locking
Rel(buyer, buyer_escrow, "1. Lock THBS", "SPL Token")
Rel(seller, seller_escrow, "1. Lock GRX", "SPL Token")

note right of settlement
  **Atomic Operations:**
  • Transfer THBS → Seller
  • Transfer GRX → Buyer
  • Deduct Fees
  
  *(All succeed or all revert)*
end note

note left of buyer_escrow
  **Token Legend:**
  • **THBS**: Thai Baht Stablecoin
    (1 THBS = 1 THB)
  • **GRX**: GridToken (Energy)
    (1 GRX = 1 kWh)
end note
' Step 2: Settlement Trigger
Rel(buyer_escrow, settlement, "2a. THBS Available")
Rel(seller_escrow, settlement, "2b. GRX Available")

' Results
Rel(settlement, seller, "3. Receives THBS")
Rel(settlement, buyer, "4. Receives GRX")
Rel(settlement, fee_pool, "5. Fees")

footer GridTokenX | Atomic Settlement Architecture | 2026
@enduml

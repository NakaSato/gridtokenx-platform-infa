@startuml
!include <C4/C4_Component>
!include <tupadr3/devicons/rust>
!include <tupadr3/devicons/postgresql>
!include <tupadr3/devicons/redis>
!include <tupadr3/font-awesome-5/coins>
!include <tupadr3/font-awesome-5/server>

skinparam defaultFontName "Helvetica Neue"

title **GridTokenX - Component Diagram: API Gateway**\nRust / Axum Microservice Architecture

' Container Context
Container(api_gateway, "API Gateway", "Rust/Axum", "The core backend orchestration service.")

System_Boundary(api_internals, "API Gateway Components") {
    
    Component(auth_handler, "Auth Controller", "Axum Handler", "Manages JWT issuance, wallet verification, and session guards.", $sprite="rust")
    Component(market_controller, "Market Controller", "Rust Struct", "Handles order placement, matching engine triggers, and book queries.")
    Component(telemetry_consumer, "Telemetry Consumer", "Tokio Task", "Consumes Kafka events, validates energy data, and writes to DB.")
    Component(tx_builder, "Transaction Builder", "Solana SDK", "Constructs and signs transactions for on-chain execution.")
    Component(ws_manager, "WebSocket Manager", "Axum WS", "Real-time order book updates and trade notifications.")

    ComponentDb(repo_layer, "Repository Layer", "SQLx / Diesel", "Abstracts database access and query construction.")
}

' External Supporting Containers
ContainerDb(db, "PostgreSQL", "Relational DB", "Stores user, order, and device data.", $sprite="postgresql")
ContainerDb(redis, "Redis", "Cache", "Stores active sessions and pub/sub channels.", $sprite="redis")
ContainerQueue(kafka, "Kafka", "Event Bus", "Source of smart meter readings.", $sprite="server")
Container(blockchain, "Solana", "L1 Chain", "Destination for atomic settlement.", $sprite="coins")

' Internal Relationships
Rel(auth_handler, repo_layer, "Reads User Data")
Rel(auth_handler, redis, "Checks Session")

Rel(market_controller, repo_layer, "Persists Orders")
Rel(market_controller, tx_builder, "Requests Settlement")
Rel(market_controller, ws_manager, "Publishes Updates")

Rel(telemetry_consumer, kafka, "Consumes Readings")
Rel(telemetry_consumer, repo_layer, "Saves Metrics")

Rel(tx_builder, blockchain, "Submits Tx", "RPC")
Rel(repo_layer, db, "SQL Queries")

' Layout Hints
Lay_R(auth_handler, market_controller)
Lay_D(market_controller, tx_builder)
@enduml

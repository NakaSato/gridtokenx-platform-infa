@startuml
!include <C4/C4_Sequence>

skinparam defaultFontName "Helvetica Neue"
title **GridTokenX: User & Device Onboarding**\nRegistry & Governance Flow

actor "Prosumer" as User
participant "API Gateway" as API
participant "Registry Program" as Registry
participant "Governance Program" as Gov
database "Off-Chain DB" as Check
entity "ErcCertificate PDA" as ERC
entity "User PDA" as UserAcc
entity "Meter PDA" as MeterAcc

== User Registration ==
User -> API: Register(UserType, Location)
API -> Check: KYC / Sanctions Check
Check --> API: Approved
API -> Registry: **register_user(UserType, Lat, Long)**
activate Registry
Registry -> UserAcc: Initialise PDA seeds=[b"user", authority]
Registry -> UserAcc: Set Status = Active
Registry --> API: Success
deactivate Registry
API --> User: Registration Complete

== Energy Certificate Issuance ==
User -> API: Request ERC (proof of renewable source)
API -> Gov: **issue_erc(cert_id, amount, source)**
activate Gov
Gov -> ERC: Init PDA seeds=[b"erc_cert", id]
Gov -> ERC: Store Validation Data
Gov --> API: Created
deactivate Gov

note right of Gov: Admin validates documents off-chain

API -> Gov: **validate_erc_for_trading()**
activate Gov
Gov -> ERC: Set validated_for_trading = true
Gov --> API: Validated
deactivate Gov

== Smart Meter Linking ==
User -> API: Register Meter(Start Meter ID)
API -> Registry: **register_meter(meter_id, type)**
activate Registry
Registry -> UserAcc: Check Authority (Owned by Signer)
Registry -> MeterAcc: Init PDA seeds=[b"meter", owner, id]
Registry -> MeterAcc: Set Status = Active
Registry --> API: Success
deactivate Registry

API --> User: Device Onboarded

@enduml

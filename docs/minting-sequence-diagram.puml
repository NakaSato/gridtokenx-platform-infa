@startuml
!pragma teoz true

' ============================================================================
' GridTokenX - Token Minting Sequence Diagram
' Energy Token Minting Process Flow
' Version: 2.0
' ============================================================================

title <size:20>**GridTokenX - Token Minting Sequence**</size>\nEnergy Token Minting Process Flow

' Visual Configuration
skinparam defaultFontName "Helvetica Neue"
skinparam defaultFontSize 12
skinparam roundCorner 8
skinparam shadowing false

skinparam sequence {
    ArrowColor #2C3E50
    ArrowFontSize 11
    LifeLineBorderColor #34495E
    LifeLineBackgroundColor #ECF0F1
    
    ParticipantBorderColor #2980B9
    ParticipantBackgroundColor #3498DB
    ParticipantFontColor white
    ParticipantFontStyle bold
    
    ActorBorderColor #27AE60
    ActorBackgroundColor #2ECC71
    
    GroupBackgroundColor #F8F9FA
    GroupBorderColor #DEE2E6
    
    DividerBackgroundColor #E9ECEF
    DividerBorderColor #CED4DA
    
    BoxBorderColor #6C757D
    BoxBackgroundColor #F8F9FA
}

skinparam note {
    BackgroundColor #FFF9C4
    BorderColor #F9A825
}

' Participants Definition
actor "Energy Producer\n(Prosumer)" as User #27AE60
box "Frontend Layer" #E3F2FD
    participant "Trading App\n//Next.js + Wallet//" as FE #2196F3
end box

box "Backend Layer" #FFF3E0
    participant "API Gateway\n//Rust / Axum//" as API #FF9800
    participant "Kafka\n//Message Queue//" as KAFKA #795548
end box

box "Data Layer" #F3E5F5
    database "PostgreSQL\n//Persistent Store//" as DB #9C27B0
    database "Redis\n//Cache / Session//" as REDIS #E91E63
end box

box "External Services" #E8F5E9
    participant "Pyth Oracle\n//Price Feed//" as ORACLE #4CAF50
end box

box "Solana Blockchain" #EDE7F6
    participant "Anchor Programs\n//GridTokenX//" as ANCHOR #673AB7
    participant "SPL Token\n//Token Program//" as SPL #512DA8
end box

' ============================================================================
' PHASE 1: USER AUTHENTICATION & SESSION
' ============================================================================
== <size:14>**â‘  Authentication & Wallet Connection**</size> ==

autonumber "<b>[0]</b>"

User -> FE : Connect Wallet (Phantom/Solflare)
activate FE #BBDEFB
FE -> FE : Initialize Wallet Adapter
FE --> User : Wallet Connected

User -> FE : Access Minting Portal
FE -> API : POST /api/auth/session\n{wallet_address}
activate API #FFE0B2
API -> DB : Query prosumer_registry
activate DB #E1BEE7
DB --> API : Prosumer Profile & Permissions
deactivate DB
API -> REDIS : SET session:{wallet} TTL=3600
activate REDIS #F8BBD9
REDIS --> API : OK
deactivate REDIS
API --> FE : Session Token + User Profile
deactivate API
FE --> User : Display Minting Dashboard
deactivate FE

' ============================================================================
' PHASE 2: ENERGY DATA VALIDATION
' ============================================================================
== <size:14>**â‘¡ Energy Data Collection & Validation**</size> ==

User -> FE : Submit Energy Reading\n(MWh Produced)
activate FE #BBDEFB

note over FE : Validates format:\nâ€¢ Positive number\nâ€¢ Within daily limits

FE -> API : POST /api/energy/validate\n{meter_id, reading_mwh, timestamp}
activate API #FFE0B2

API -> KAFKA : Subscribe: meter-readings
activate KAFKA #BCAAA4
KAFKA --> API : Latest meter data stream
deactivate KAFKA

API -> DB : SELECT production_history\nWHERE meter_id = ? AND date >= ?
activate DB #E1BEE7
DB --> API : Historical Production Data
deactivate DB

note right of API
  **Validation Checks:**
  âœ“ Reading within meter capacity
  âœ“ No duplicate submission
  âœ“ Timestamp validity
  âœ“ Production rate consistency
end note

API -> ORACLE : GET /v2/price_feeds/energy
activate ORACLE #C8E6C9
ORACLE --> API : Current Energy Price (USD/MWh)
deactivate ORACLE

API -> REDIS : SETEX validation:{reading_id} 300 {result}
activate REDIS #F8BBD9
REDIS --> API : OK
deactivate REDIS

API --> FE : Validation Result\n{eligible_mwh, token_rate, estimated_tokens}
deactivate API

FE --> User : Display Eligible Amount\n& Token Preview
deactivate FE

' ============================================================================
' PHASE 3: MINTING AUTHORIZATION
' ============================================================================
== <size:14>**â‘¢ Minting Authorization Request**</size> ==

User -> FE : Confirm Minting Request
activate FE #BBDEFB

FE -> API : POST /api/mint/authorize\n{reading_id, amount_mwh}
activate API #FFE0B2

API -> REDIS : GET validation:{reading_id}
activate REDIS #F8BBD9
REDIS --> API : Cached Validation Result
deactivate REDIS

API -> DB : Check minting_quotas\nWHERE prosumer_id = ?
activate DB #E1BEE7
DB --> API : Daily/Monthly Quota Status
deactivate DB

alt #FFEBEE Quota Exceeded
    API --> FE : 429 Rate Limited\n{quota_reset_time}
    FE --> User : Quota Exceeded Message
else #E8F5E9 Quota Available
    API -> DB : INSERT mint_requests\n(status: PENDING)
    activate DB #E1BEE7
    DB --> API : request_id
    deactivate DB
    API --> FE : Authorization Granted\n{request_id, nonce}
end
deactivate API

FE --> User : Request Transaction Signature
deactivate FE

' ============================================================================
' PHASE 4: BLOCKCHAIN MINTING
' ============================================================================
== <size:14>**â‘£ Blockchain Token Minting**</size> ==

User -> FE : Sign Transaction\n(Wallet Popup)
activate FE #BBDEFB

note over User, FE #BBFFBB : User reviews and approves\ntransaction in wallet extension

FE -> ANCHOR : invoke: mint_energy_tokens\n{request_id, amount, signature}
activate ANCHOR #D1C4E9

ANCHOR -> ANCHOR : Verify mint authority PDA
ANCHOR -> ANCHOR : Validate oracle price attestation
ANCHOR -> ANCHOR : Check supply constraints

note over ANCHOR
  **On-Chain Validations:**
  â€¢ Prosumer registry check
  â€¢ Oracle signature verification
  â€¢ Token supply limits
  â€¢ Rate limiting PDA
end note

ANCHOR -> SPL : CPI: mint_to\n{mint, destination, amount}
activate SPL #C5CAE9
SPL -> SPL : Update token supply
SPL -> SPL : Update destination balance
SPL --> ANCHOR : MintTo Success
deactivate SPL

ANCHOR --> FE : Transaction Signature\n{tx_hash, slot, tokens_minted}
deactivate ANCHOR

FE -> API : POST /api/mint/confirm\n{request_id, tx_hash}
activate API #FFE0B2

API -> DB : UPDATE mint_requests\nSET status = 'COMPLETED',\ntx_hash = ?
activate DB #E1BEE7
DB --> API : Updated
deactivate DB

API -> REDIS : PUBLISH channel:user:{wallet}\n{type: 'mint_complete', ...}
activate REDIS #F8BBD9
REDIS --> API : Published
deactivate REDIS

API --> FE : Confirmation Response
deactivate API

FE --> User : ðŸŽ‰ Minting Successful!\nTokens Added to Wallet
deactivate FE

' ============================================================================
' PHASE 5: POST-MINTING OPERATIONS
' ============================================================================
== <size:14>**â‘¤ Post-Minting & Notifications**</size> ==

API ->> KAFKA : PRODUCE: minting-events\n{producer_id, amount, tx_hash}
activate KAFKA #BCAAA4
note right of KAFKA : Event sourcing for\nanalytics & audit
deactivate KAFKA

API ->> DB : INSERT transaction_log\n(for audit trail)

User -> FE : View Updated Balance
activate FE #BBDEFB
FE -> ANCHOR : getTokenAccountBalance\n(user_wallet)
activate ANCHOR #D1C4E9
ANCHOR --> FE : {balance, decimals}
deactivate ANCHOR
FE --> User : Display New Token Balance\n& Transaction Receipt
deactivate FE

' ============================================================================
' ERROR HANDLING SCENARIOS
' ============================================================================
== <size:14>**â‘¥ Error Handling Scenarios**</size> ==

alt #FFCDD2 Validation Failed
    API -[#D32F2F]-> FE : 400 Bad Request\n{error_code, message}
    FE -[#D32F2F]-> User : âš ï¸ Validation Error\n(Correct Data Prompt)
else #FFCDD2 Insufficient Permissions
    API -[#D32F2F]-> FE : 403 Forbidden\n{required_role}
    FE -[#D32F2F]-> User : ðŸ”’ Access Denied
else #FFCDD2 Blockchain Transaction Failed
    ANCHOR -[#D32F2F]-> FE : TransactionError\n{logs, error_code}
    FE -> API : POST /api/mint/failed\n{request_id, error}
    activate API #FFE0B2
    API -> DB : UPDATE mint_requests\nSET status = 'FAILED',\nerror_log = ?
    activate DB #E1BEE7
    DB --> API : Updated
    deactivate DB
    API --> FE : Failure Acknowledged
    deactivate API
    FE -[#D32F2F]-> User : âŒ Transaction Failed\n(Retry Option)
else #FFCDD2 Network/Timeout Error
    FE -[#D32F2F]-> User : ðŸ“¡ Connection Error\n(Auto-Retry in Progress)
    FE -> FE : Exponential backoff retry
end

' ============================================================================
' MONITORING & OBSERVABILITY
' ============================================================================
== <size:14>**â‘¦ Monitoring & Observability**</size> ==

API ->> DB : INSERT metric_logs\n{endpoint, latency, status}
API ->> API : Prometheus metrics\n(mint_requests_total)
API ->> REDIS : INCR stats:daily:mints:{date}

note over API, DB
  **Collected Metrics:**
  â€¢ Request latency (p50, p95, p99)
  â€¢ Success/failure rates
  â€¢ Token volume minted
  â€¢ Active prosumers
end note

' Footer
footer <size:10>GridTokenX Platform | Token Minting Flow v2.0 | Last Updated: 2026-01</size>
@enduml

@startuml
!pragma teoz true

' ============================================================================
' GridTokenX - Token Minting Sequence Diagram
' Energy Token Minting Process Flow
' Version: 2.0
' ============================================================================

title <size:20>**GridTokenX - Token Minting Sequence**</size>\nEnergy Token Minting Process Flow



' Participants Definition
actor "Energy Producer\n(Prosumer)" as User
box "Frontend Layer"
    participant "Trading App\n//Next.js + Wallet//" as FE
end box

box "Backend Layer"
    participant "API Gateway\n//Rust / Axum//" as API
    participant "Kafka\n//Message Queue//" as KAFKA
end box

box "Data Layer"
    database "PostgreSQL\n//Persistent Store//" as DB
    database "Redis\n//Cache / Session//" as REDIS
end box

box "External Services"
    participant "Pyth Oracle\n//Price Feed//" as ORACLE
end box

box "Solana Blockchain"
    participant "Anchor Programs\n//GridTokenX//" as ANCHOR
    participant "SPL Token\n//Token Program//" as SPL
end box

' ============================================================================
' PHASE 1: USER AUTHENTICATION & SESSION
' ============================================================================
== <size:14>**â‘  Authentication & Wallet Connection**</size> ==

autonumber "<b>[0]</b>"

User -> FE : Connect Wallet (Phantom/Solflare)
activate FE
FE -> FE : Initialize Wallet Adapter
FE --> User : Wallet Connected

User -> FE : Access Minting Portal
FE -> API : POST /api/auth/session\n{wallet_address}
activate API
API -> DB : Query prosumer_registry
activate DB
DB --> API : Prosumer Profile & Permissions
deactivate DB
API -> REDIS : SET session:{wallet} TTL=3600
activate REDIS
REDIS --> API : OK
deactivate REDIS
API --> FE : Session Token + User Profile
deactivate API
FE --> User : Display Minting Dashboard
deactivate FE

' ============================================================================
' PHASE 2: ENERGY DATA VALIDATION
' ============================================================================
== <size:14>**â‘¡ Energy Data Collection & Validation**</size> ==

User -> FE : Submit Energy Reading\n(MWh Produced)
activate FE

note over FE : Validates format:\nâ€¢ Positive number\nâ€¢ Within daily limits

FE -> API : POST /api/energy/validate\n{meter_id, reading_mwh, timestamp}
activate API

API -> KAFKA : Subscribe: meter-readings
activate KAFKA
KAFKA --> API : Latest meter data stream
deactivate KAFKA

API -> DB : SELECT production_history\nWHERE meter_id = ? AND date >= ?
activate DB
DB --> API : Historical Production Data
deactivate DB

note right of API
  **Validation Checks:**
  âœ“ Reading within meter capacity
  âœ“ No duplicate submission
  âœ“ Timestamp validity
  âœ“ Production rate consistency
end note

API -> ORACLE : GET /v2/price_feeds/energy
activate ORACLE
ORACLE --> API : Current Energy Price (USD/MWh)
deactivate ORACLE

API -> REDIS : SETEX validation:{reading_id} 300 {result}
activate REDIS
REDIS --> API : OK
deactivate REDIS

API --> FE : Validation Result\n{eligible_mwh, token_rate, estimated_tokens}
deactivate API

FE --> User : Display Eligible Amount\n& Token Preview
deactivate FE

' ============================================================================
' PHASE 3: MINTING AUTHORIZATION
' ============================================================================
== <size:14>**â‘¢ Minting Authorization Request**</size> ==

User -> FE : Confirm Minting Request
activate FE

FE -> API : POST /api/mint/authorize\n{reading_id, amount_mwh}
activate API

API -> REDIS : GET validation:{reading_id}
activate REDIS
REDIS --> API : Cached Validation Result
deactivate REDIS

API -> DB : Check minting_quotas\nWHERE prosumer_id = ?
activate DB
DB --> API : Daily/Monthly Quota Status
deactivate DB

alt Quota Exceeded
    API --> FE : 429 Rate Limited\n{quota_reset_time}
    FE --> User : Quota Exceeded Message
else Quota Available
    API -> DB : INSERT mint_requests\n(status: PENDING)
    activate DB
    DB --> API : request_id
    deactivate DB
    API --> FE : Authorization Granted\n{request_id, nonce}
end
deactivate API

FE --> User : Request Transaction Signature
deactivate FE

' ============================================================================
' PHASE 4: BLOCKCHAIN MINTING
' ============================================================================
== <size:14>**â‘£ Blockchain Token Minting**</size> ==

User -> FE : Sign Transaction\n(Wallet Popup)
activate FE

note over User, FE : User reviews and approves\ntransaction in wallet extension

FE -> ANCHOR : invoke: mint_energy_tokens\n{request_id, amount, signature}
activate ANCHOR

ANCHOR -> ANCHOR : Verify mint authority PDA
ANCHOR -> ANCHOR : Validate oracle price attestation
ANCHOR -> ANCHOR : Check supply constraints

note over ANCHOR
  **On-Chain Validations:**
  â€¢ Prosumer registry check
  â€¢ Oracle signature verification
  â€¢ Token supply limits
  â€¢ Rate limiting PDA
end note

ANCHOR -> SPL : CPI: mint_to\n{mint, destination, amount}
activate SPL
SPL -> SPL : Update token supply
SPL -> SPL : Update destination balance
SPL --> ANCHOR : MintTo Success
deactivate SPL

ANCHOR --> FE : Transaction Signature\n{tx_hash, slot, tokens_minted}
deactivate ANCHOR

FE -> API : POST /api/mint/confirm\n{request_id, tx_hash}
activate API

API -> DB : UPDATE mint_requests\nSET status = 'COMPLETED',\ntx_hash = ?
activate DB
DB --> API : Updated
deactivate DB

API -> REDIS : PUBLISH channel:user:{wallet}\n{type: 'mint_complete', ...}
activate REDIS
REDIS --> API : Published
deactivate REDIS

API --> FE : Confirmation Response
deactivate API

FE --> User : ðŸŽ‰ Minting Successful!\nTokens Added to Wallet
deactivate FE

' ============================================================================
' PHASE 5: POST-MINTING OPERATIONS
' ============================================================================
== <size:14>**â‘¤ Post-Minting & Notifications**</size> ==

API ->> KAFKA : PRODUCE: minting-events\n{producer_id, amount, tx_hash}
activate KAFKA
note right of KAFKA : Event sourcing for\nanalytics & audit
deactivate KAFKA

API ->> DB : INSERT transaction_log\n(for audit trail)

User -> FE : View Updated Balance
activate FE
FE -> ANCHOR : getTokenAccountBalance\n(user_wallet)
activate ANCHOR
ANCHOR --> FE : {balance, decimals}
deactivate ANCHOR
FE --> User : Display New Token Balance\n& Transaction Receipt
deactivate FE

' ============================================================================
' ERROR HANDLING SCENARIOS
' ============================================================================
== <size:14>**â‘¥ Error Handling Scenarios**</size> ==

alt Validation Failed
    API --> FE : 400 Bad Request\n{error_code, message}
    FE --> User : âš ï¸ Validation Error\n(Correct Data Prompt)
else Insufficient Permissions
    API --> FE : 403 Forbidden\n{required_role}
    FE --> User : ðŸ”’ Access Denied
else Blockchain Transaction Failed
    ANCHOR --> FE : TransactionError\n{logs, error_code}
    FE -> API : POST /api/mint/failed\n{request_id, error}
    activate API
    API -> DB : UPDATE mint_requests\nSET status = 'FAILED',\nerror_log = ?
    activate DB
    DB --> API : Updated
    deactivate DB
    API --> FE : Failure Acknowledged
    deactivate API
    FE --> User : âŒ Transaction Failed\n(Retry Option)
else Network/Timeout Error
    FE --> User : ðŸ“¡ Connection Error\n(Auto-Retry in Progress)
    FE -> FE : Exponential backoff retry
end

' ============================================================================
' MONITORING & OBSERVABILITY
' ============================================================================
== <size:14>**â‘¦ Monitoring & Observability**</size> ==

API ->> DB : INSERT metric_logs\n{endpoint, latency, status}
API ->> API : Prometheus metrics\n(mint_requests_total)
API ->> REDIS : INCR stats:daily:mints:{date}

note over API, DB
  **Collected Metrics:**
  â€¢ Request latency (p50, p95, p99)
  â€¢ Success/failure rates
  â€¢ Token volume minted
  â€¢ Active prosumers
end note

' Footer
footer <size:10>GridTokenX Platform | Token Minting Flow v2.0 | Last Updated: 2026-01</size>
@enduml

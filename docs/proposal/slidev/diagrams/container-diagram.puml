@startuml
!include <C4/C4_Container>
!include <tupadr3/devicons/react>
!include <tupadr3/devicons/python>
!include <tupadr3/devicons/rust>
!include <tupadr3/devicons/postgresql>
!include <tupadr3/devicons/redis>
!include <tupadr3/font-awesome-5/coins>
!include <tupadr3/font-awesome-5/user>
!include <tupadr3/font-awesome-5/server>
!include <tupadr3/font-awesome-5/bolt>
!include <tupadr3/devicons/linux>
!include <tupadr3/font-awesome-5/broadcast_tower>
!include <tupadr3/font-awesome-5/map>

skinparam defaultFontName "Helvetica Neue"

title **GridTokenX - Container Diagram**\nApp Architecture & Technology Stack

' Person
Person(user, "Prosumer", "Energy producer/consumer managing smart meters and trading tokens.", $sprite="user")

System_Boundary(platform, "GridTokenX Platform") {

    System_Boundary(frontend_layer, "Frontend Layer") {
        Container(trading_app, "Trading Dashboard", "Next.js, React", "Primary interface for trading, monitoring, and wallet management.", $sprite="react")
    }

    System_Boundary(backend_layer, "Service Layer") {
        Container(gateway, "API Gateway", "Rust, Axum", "Central orchestration, high-performance API portal, and security.", $sprite="rust")
        Container(simulator, "Smart Meter Sim", "Python, FastAPI", "Generates simulated real-time grid telemetry.", $sprite="python")
    }

    System_Boundary(data_layer, "Persistence & Streaming") {
        ContainerQueue(kafka, "Event Stream", "Apache Kafka", "High-throughput ingestion for smart meter telemetry.", $sprite="server")
        ContainerDb(cache, "Session & Cache", "Redis", "Real-time state, session management, and pub/sub events.", $sprite="redis")
        ContainerDb(db, "Primary DB", "PostgreSQL", "Relational storage for users, orders, and historical state.", $sprite="postgresql")
        ContainerDb(influx, "Metrics DB", "InfluxDB", "Time-series storage for granular energy production analytics.", $sprite="bolt")
    }

    System_Boundary(blockchain_layer, "Blockchain Layer") {
        Container(blockchain, "Solana Network", "Anchor Framework", "On-chain state: Registry, Governance, and Energy Token (SPL).", $sprite="coins")
    }
}

' External Systems
System_Ext(pyth, "Pyth Network", "Decentralized Oracle providing real-time energy price feeds.", $sprite="broadcast_tower")
System_Ext(mapbox, "Mapbox", "Geospatial service for grid topology.", $sprite="map")

' User Interactions
Rel_D(user, trading_app, "Manages wallet & trades", "HTTPS")

' Frontend Interactions
Rel_D(trading_app, gateway, "API Requests", "REST / WSS")
Rel_R(trading_app, mapbox, "Fetches Maps", "HTTPS")
Rel_D(trading_app, blockchain, "Signs Tx (Wallet)", "RPC")

' Backend Interactions
Rel_D(gateway, db, "Query/Persist", "SQL")
Rel_D(gateway, cache, "Cache Ops", "RESP")
Rel_D(gateway, kafka, "Consumes readings", "Kafka")
Rel_R(gateway, blockchain, "State Check", "RPC")
Rel_R(gateway, pyth, "Consumes Prices", "HTTPS")

' Simulator Flows
Rel_R(simulator, kafka, "Produces readings", "Kafka")
Rel_D(simulator, influx, "Stores telemetry", "Line Protocol")
Rel_D(simulator, db, "Get Config", "SQL")

' Layout positioning hints
Lay_R(frontend_layer, pyth)
Lay_D(frontend_layer, backend_layer)
Lay_D(backend_layer, data_layer)
Lay_R(gateway, blockchain_layer)

@enduml

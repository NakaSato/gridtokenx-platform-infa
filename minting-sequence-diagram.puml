@startuml

title GridTokenX - Token Minting Sequence Diagram
caption Energy Token Minting Process Flow

actor User as "Energy Producer"
participant "Frontend" as FE "React App"
participant "API Gateway" as API "Rust Backend"
participant "Auth Service" as AUTH "JWT Auth"
participant "Oracle Service" as ORACLE "Pyth Network"
participant "Solana Program" as SOL "Token Program"
database "PostgreSQL" as DB "Database"

== 1. Authentication & Initialization ==
autonumber 1
User -> FE: Access Minting Portal
FE -> API: Request Authentication
API -> AUTH: Validate JWT Token
AUTH --> API: Return User Profile
API --> FE: User Authentication Data
FE --> User: Display Minting Interface

== 2. Energy Data Validation ==
User -> FE: Submit Energy Reading (MWh Produced)
FE -> API: POST /api/energy/validate
API -> DB: Query Historical Data (Production Limits)
DB --> API: Return Energy History
API -> ORACLE: Verify Energy Data (External Validation)
ORACLE --> API: Energy Data Confirmation
API --> FE: Validation Result
FE --> User: Show Eligible Amount

== 3. Minting Authorization ==
User -> FE: Confirm Minting Request
FE -> API: POST /api/mint/request
API -> AUTH: Verify Minting Permissions
AUTH --> API: Authorization Granted
API -> DB: Create Minting Record (Status: PENDING)
DB --> API: Record Created

== 4. Blockchain Minting Process ==
API -> SOL: invoke(mint_tokens)
note right of SOL: Anchor Program Execution
SOL -> SOL: Validate Mint Authority
SOL -> SOL: Check Token Supply Limits
SOL -> SOL: Calculate Token Amount (MWh * Token Rate)
SOL -> SOL: Create Token Mint (Producer's Wallet)
SOL --> API: Return Mint Signature
API -> DB: Update Minting Record (Status: COMPLETED)
API --> FE: Minting Success Response
FE --> User: Display Transaction Success

== 5. Post-Minting Operations ==
API -> FE: Real-time Update (Wallet Balance)
FE -> User: Show New Token Balance
User -> FE: View Transaction History
FE -> API: GET /api/transactions
API -> DB: Query Transaction Records
DB --> API: Return Transaction Data
API --> FE: Transaction History
FE --> User: Display Transaction Details

== 6. Error Handling ==
alt Validation Failed
    API --> FE: Error Response
    FE --> User: Show Error Message
    User -> FE: Correct Energy Data
else Insufficient Permissions
    API --> FE: 403 Forbidden
    FE --> User: Access Denied Message
else Blockchain Error
    SOL --> API: Transaction Failed
    API -> DB: Update Record (Status: FAILED)
    API --> FE: Blockchain Error
    FE --> User: Technical Error Notice
end

== 7. Monitoring & Logging ==
API -> DB: Log Minting Metrics
API -> API: Update Analytics (Daily/Weekly Stats)
API -> API: Send Notification (Producer Dashboard)

@enduml

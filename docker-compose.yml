services:
  # PostgreSQL Database for API Gateway
  postgres:
    image: postgres:16-alpine
    container_name: gridtokenx-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-gridtokenx}
      POSTGRES_USER: ${POSTGRES_USER:-gridtokenx_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-gridtokenx_password}
    command:
      - "postgres"
      - "-c"
      - "max_connections=100"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "work_mem=16MB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "log_statement=mod"
      - "-c"
      - "log_duration=on"
      - "-c"
      - "log_min_duration_statement=1000"
      - "-c"
      - "shared_preload_libraries=pg_stat_statements"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - gridtokenx-network
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-gridtokenx_user}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache for API Gateway
  redis:
    image: redis:7-alpine
    container_name: gridtokenx-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - gridtokenx-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5

  # API Gateway (Rust/Axum)
  apigateway:
    build:
      context: ./gridtokenx-apigateway
      dockerfile: Dockerfile
    container_name: gridtokenx-apigateway
    ports:
      - "${APIGATEWAY_PORT:-8080}:8080"
    environment:
      # Application Configuration
      PORT: ${PORT:-8080}
      SERVER_HOST: ${SERVER_HOST:-0.0.0.0}
      SERVER_PORT: ${SERVER_PORT:-8080}
      ENVIRONMENT: ${ENVIRONMENT:-development}
      RUST_LOG: ${RUST_LOG:-info}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      AUDIT_LOG_ENABLED: ${AUDIT_LOG_ENABLED:-true}
      TEST_MODE: ${TEST_MODE:-false}

      # Database Configuration
      DATABASE_URL: postgresql://${POSTGRES_USER:-gridtokenx_user}:${POSTGRES_PASSWORD:-gridtokenx_password}@postgres:5432/${POSTGRES_DB:-gridtokenx}
      MAX_CONNECTIONS: ${MAX_CONNECTIONS:-50}
      MIN_CONNECTIONS: ${MIN_CONNECTIONS:-5}
      DATABASE_MAX_CONNECTIONS: ${DATABASE_MAX_CONNECTIONS:-50}
      DATABASE_MIN_CONNECTIONS: ${DATABASE_MIN_CONNECTIONS:-5}

      # Redis Configuration
      REDIS_URL: redis://redis:${REDIS_PORT:-6379}
      REDIS_POOL_SIZE: ${REDIS_POOL_SIZE:-20}
      REDIS_MAX_CONNECTIONS: ${REDIS_MAX_CONNECTIONS:-20}
      REDIS_CONNECTION_TIMEOUT: ${REDIS_CONNECTION_TIMEOUT:-5}
      REDIS_COMMAND_TIMEOUT: ${REDIS_COMMAND_TIMEOUT:-3}
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT:-30}

      # InfluxDB Configuration
      INFLUXDB_URL: ${INFLUXDB_URL:-http://localhost:8086}
      INFLUXDB_TOKEN: ${INFLUXDB_TOKEN:-your-influxdb-token}
      INFLUXDB_ORG: ${INFLUXDB_ORG:-gridtokenx}
      INFLUXDB_BUCKET: ${INFLUXDB_BUCKET:-energy_readings}

      # Solana Blockchain Configuration
      SOLANA_RPC_URL: ${SOLANA_RPC_URL:-http://localhost:8899}
      SOLANA_WS_URL: ${SOLANA_WS_URL:-ws://localhost:8900}
      SOLANA_CLUSTER: ${SOLANA_CLUSTER:-localnet}

      # Program IDs
      REGISTRY_PROGRAM_ID: ${REGISTRY_PROGRAM_ID:-FSXdxk5uPUvJc51MzjtBaCDrFh7RSMcHFHKpzCG9LeuJ}
      ENERGY_TOKEN_PROGRAM_ID: ${ENERGY_TOKEN_PROGRAM_ID:-FaELH72fUMRaLTX3ersmQLr4purfHGvJccm1BXfDPL6r}
      TRADING_PROGRAM_ID: ${TRADING_PROGRAM_ID:-CEWpf4Rvm3SU2zQgwsQpi5EMYBUrWbKLcAhAT2ouVoWD}
      ORACLE_PROGRAM_ID: ${ORACLE_PROGRAM_ID:-G365L8A4Y3xmp5aN2GGLj2SJr5KetgE5F57PaFvCgSgG}
      GOVERNANCE_PROGRAM_ID: ${GOVERNANCE_PROGRAM_ID:-EAcyEzfXXJCDnjZKUrgHsBEEHmnozZJXKs2wdW3xnWgb}
      ENERGY_TOKEN_MINT: ${ENERGY_TOKEN_MINT:-9WzDXwBbmkg8ZTbNMqUxvQRAyrZzDsGYdLVL9zYtAWWM}

      # Keypair Paths
      ENGINEERING_KEYPAIR_PATH: ${ENGINEERING_KEYPAIR_PATH:-./validator-keys/engineering-keypair.json}
      ORACLE_KEYPAIR_PATH: ${ORACLE_KEYPAIR_PATH:-./validator-keys/oracle-keypair.json}
      ENGINEERING_DEPT_KEYPAIR_PATH: ${ENGINEERING_DEPT_KEYPAIR_PATH:-./validator-keys/engineering-department-authority.json}

      # Authentication & Security
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-key-minimum-32-characters-long-for-development-2025}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-86400}
      API_KEY_SECRET: ${API_KEY_SECRET:-test-api-key-secret-for-development-and-testing}
      ENGINEERING_API_KEY: ${ENGINEERING_API_KEY:-engineering-department-api-key-2025}
      HMAC_SECRET: ${HMAC_SECRET:-hmac-signature-secret-change-in-production}

      # Password Requirements
      PASSWORD_MIN_LENGTH: ${PASSWORD_MIN_LENGTH:-8}
      PASSWORD_REQUIRE_UPPERCASE: ${PASSWORD_REQUIRE_UPPERCASE:-true}
      PASSWORD_REQUIRE_LOWERCASE: ${PASSWORD_REQUIRE_LOWERCASE:-true}
      PASSWORD_REQUIRE_NUMBERS: ${PASSWORD_REQUIRE_NUMBERS:-true}
      PASSWORD_REQUIRE_SPECIAL_CHARS: ${PASSWORD_REQUIRE_SPECIAL_CHARS:-true}

      # Security Settings
      SECURE_COOKIES: ${SECURE_COOKIES:-false}
      SESSION_TIMEOUT: ${SESSION_TIMEOUT:-3600}
      MAX_LOGIN_ATTEMPTS: ${MAX_LOGIN_ATTEMPTS:-5}
      LOCKOUT_DURATION: ${LOCKOUT_DURATION:-900}

      # Email Configuration
      SMTP_HOST: ${SMTP_HOST:-localhost}
      SMTP_PORT: ${SMTP_PORT:-1025}
      SMTP_USERNAME: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME:-GridTokenX}
      EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS:-noreply@gridtokenx.com}
      SMTP_FROM: ${SMTP_FROM:-noreply@gridtokenx.com}
      EMAIL_VERIFICATION_ENABLED: ${EMAIL_VERIFICATION_ENABLED:-true}
      EMAIL_VERIFICATION_REQUIRED: ${EMAIL_VERIFICATION_REQUIRED:-false}
      EMAIL_VERIFICATION_EXPIRY_HOURS: ${EMAIL_VERIFICATION_EXPIRY_HOURS:-24}
      EMAIL_VERIFICATION_BASE_URL: ${EMAIL_VERIFICATION_BASE_URL:-http://localhost:3000}
      EMAIL_AUTO_LOGIN_AFTER_VERIFICATION: ${EMAIL_AUTO_LOGIN_AFTER_VERIFICATION:-true}
      ENABLE_EMAIL_VERIFICATION: ${ENABLE_EMAIL_VERIFICATION:-true}
      ENABLE_EMAIL_NOTIFICATIONS: ${ENABLE_EMAIL_NOTIFICATIONS:-true}

      # CORS Configuration
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:8080}
      CORS_ALLOWED_METHODS: ${CORS_ALLOWED_METHODS:-GET,POST,PUT,PATCH,DELETE,OPTIONS}
      CORS_ALLOWED_HEADERS: ${CORS_ALLOWED_HEADERS:-*}
      CORS_EXPOSE_HEADERS: ${CORS_EXPOSE_HEADERS:-*}
      CORS_MAX_AGE: ${CORS_MAX_AGE:-3600}

      # Rate Limiting
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-true}
      RATE_LIMIT_WINDOW: ${RATE_LIMIT_WINDOW:-60}
      RATE_LIMIT_AUTH_REQUESTS: ${RATE_LIMIT_AUTH_REQUESTS:-10}
      RATE_LIMIT_AUTH_WINDOW: ${RATE_LIMIT_AUTH_WINDOW:-60}
      RATE_LIMIT_TRADING_REQUESTS: ${RATE_LIMIT_TRADING_REQUESTS:-20}
      RATE_LIMIT_TRADING_WINDOW: ${RATE_LIMIT_TRADING_WINDOW:-60}

      # Monitoring & Observability
      ENABLE_METRICS: ${ENABLE_METRICS:-true}
      ENABLE_TRACING: ${ENABLE_TRACING:-true}
      PROMETHEUS_METRICS_ENABLED: ${PROMETHEUS_METRICS_ENABLED:-true}
      METRICS_PORT: ${METRICS_PORT:-9090}

      # Feature Flags
      ENABLE_WEBSOCKET: ${ENABLE_WEBSOCKET:-true}
      ENABLE_BLOCKCHAIN_INTEGRATION: ${ENABLE_BLOCKCHAIN_INTEGRATION:-true}
      ENABLE_PUSH_NOTIFICATIONS: ${ENABLE_PUSH_NOTIFICATIONS:-false}
      ENABLE_SMS_NOTIFICATIONS: ${ENABLE_SMS_NOTIFICATIONS:-false}
      ENABLE_MARKET_DYNAMICS: ${ENABLE_MARKET_DYNAMICS:-true}

      # Cache Configuration
      CACHE_TTL_DEFAULT: ${CACHE_TTL_DEFAULT:-3600}
      CACHE_TTL_USER_SESSION: ${CACHE_TTL_USER_SESSION:-86400}
      CACHE_TTL_MARKET_DATA: ${CACHE_TTL_MARKET_DATA:-300}
      CACHE_TTL_ANALYTICS: ${CACHE_TTL_ANALYTICS:-1800}

      # Tokenization Configuration
      TOKENIZATION_KWH_TO_TOKEN_RATIO: ${TOKENIZATION_KWH_TO_TOKEN_RATIO:-1.0}
      TOKENIZATION_DECIMALS: ${TOKENIZATION_DECIMALS:-9}
      TOKENIZATION_MAX_READING_KWH: ${TOKENIZATION_MAX_READING_KWH:-100.0}
      TOKENIZATION_AUTO_MINT_ENABLED: ${TOKENIZATION_AUTO_MINT_ENABLED:-true}
      TOKENIZATION_POLLING_INTERVAL_SECS: ${TOKENIZATION_POLLING_INTERVAL_SECS:-60}
      TOKENIZATION_BATCH_SIZE: ${TOKENIZATION_BATCH_SIZE:-50}

      # Oracle Configuration
      PROCESSING_INTERVAL: ${PROCESSING_INTERVAL:-900}
      ENGINEERING_AUTHORITY: ${ENGINEERING_AUTHORITY:-true}

      # REC Configuration
      REC_AUTHORITY_ONLY: ${REC_AUTHORITY_ONLY:-true}
      REC_ISSUING_AUTHORITY: ${REC_ISSUING_AUTHORITY:-engineering-department}
      REC_CERTIFICATION_ENABLED: ${REC_CERTIFICATION_ENABLED:-true}
      CARBON_OFFSET_RATE: ${CARBON_OFFSET_RATE:-0.7}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - gridtokenx-network
    restart: unless-stopped

  # Explorer (Next.js)
  explorer:
    build:
      context: ./gridtokenx-explorer
      dockerfile: Dockerfile
    container_name: gridtokenx-explorer
    ports:
      - "${EXPLORER_PORT:-3000}:4000"
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8080}
      NEXT_PUBLIC_SOLANA_RPC_URL: ${NEXT_PUBLIC_SOLANA_RPC_URL:-https://api.devnet.solana.com}
    networks:
      - gridtokenx-network
    restart: unless-stopped

  # Trading Platform (Next.js)
  trading:
    build:
      context: ./gridtokenx-trading
      dockerfile: Dockerfile
    container_name: gridtokenx-trading
    ports:
      - "${TRADING_PORT:-3001}:3000"
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8080}
      NEXT_PUBLIC_SOLANA_RPC_URL: ${NEXT_PUBLIC_SOLANA_RPC_URL:-https://api.devnet.solana.com}
      NEXT_PUBLIC_PYTH_PRICE_SERVICE_URL: ${NEXT_PUBLIC_PYTH_PRICE_SERVICE_URL:-https://hermes.pyth.network}
    networks:
      - gridtokenx-network
    restart: unless-stopped

  # Website (Next.js with Bun)
  website:
    build:
      context: ./gridtokenx-website
      dockerfile: Dockerfile
    container_name: gridtokenx-website
    ports:
      - "${WEBSITE_PORT:-3002}:3000"
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8080}
    networks:
      - gridtokenx-network
    restart: unless-stopped

  # Smart Meter Simulator (Python/FastAPI)
  smartmeter-simulator:
    build:
      context: ./gridtokenx-smartmeter-simulator
      dockerfile: Dockerfile
    container_name: gridtokenx-smartmeter
    ports:
      - "${SMARTMETER_PORT:-8000}:8000"
    environment:
      # Database Configuration
      DATABASE_URL: postgresql://${POSTGRES_USER:-gridtokenx_user}:${POSTGRES_PASSWORD:-gridtokenx_password}@postgres:5432/${POSTGRES_DB:-gridtokenx}

      # InfluxDB Configuration
      INFLUXDB_URL: ${INFLUXDB_URL:-http://localhost:8086}
      INFLUXDB_TOKEN: ${INFLUXDB_TOKEN:-your-influxdb-token}
      INFLUXDB_ORG: ${INFLUXDB_ORG:-gridtokenx}
      INFLUXDB_BUCKET: ${INFLUXDB_BUCKET:-energy_readings}

      # Kafka Configuration (Optional)
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-}

      # Simulation Configuration
      SIMULATION_INTERVAL: ${SIMULATION_INTERVAL:-15}
      NUM_METERS: ${NUM_METERS:-20}
      SIMULATION_SPEED_MULTIPLIER: ${SIMULATION_SPEED_MULTIPLIER:-1.0}

      # Energy Configuration
      SOLAR_PANEL_EFFICIENCY_MIN: ${SOLAR_PANEL_EFFICIENCY_MIN:-0.85}
      SOLAR_PANEL_EFFICIENCY_MAX: ${SOLAR_PANEL_EFFICIENCY_MAX:-0.95}
      BASE_GENERATION_MIN: ${BASE_GENERATION_MIN:-3.0}
      BASE_GENERATION_MAX: ${BASE_GENERATION_MAX:-15.0}
      BASE_CONSUMPTION_MIN: ${BASE_CONSUMPTION_MIN:-1.5}
      BASE_CONSUMPTION_MAX: ${BASE_CONSUMPTION_MAX:-8.0}
      NOISE_FACTOR_MIN: ${NOISE_FACTOR_MIN:-0.05}
      NOISE_FACTOR_MAX: ${NOISE_FACTOR_MAX:-0.15}

      # P2P Trading Configuration
      MIN_SELL_PRICE: ${MIN_SELL_PRICE:-0.15}
      MAX_SELL_PRICE: ${MAX_SELL_PRICE:-0.35}
      MIN_BUY_PRICE: ${MIN_BUY_PRICE:-0.20}
      MAX_BUY_PRICE: ${MAX_BUY_PRICE:-0.40}
      GRID_FEED_IN_RATE: ${GRID_FEED_IN_RATE:-0.12}
      GRID_PURCHASE_RATE: ${GRID_PURCHASE_RATE:-0.28}

      # Weather Simulation
      WEATHER_SUNNY_WEIGHT: ${WEATHER_SUNNY_WEIGHT:-0.4}
      WEATHER_PARTLY_CLOUDY_WEIGHT: ${WEATHER_PARTLY_CLOUDY_WEIGHT:-0.3}
      WEATHER_CLOUDY_WEIGHT: ${WEATHER_CLOUDY_WEIGHT:-0.15}
      WEATHER_OVERCAST_WEIGHT: ${WEATHER_OVERCAST_WEIGHT:-0.1}
      WEATHER_RAINY_WEIGHT: ${WEATHER_RAINY_WEIGHT:-0.05}
      WEATHER_CHANGE_FREQUENCY: ${WEATHER_CHANGE_FREQUENCY:-5}
      RANDOM_SEED: ${RANDOM_SEED:-42}

      # Battery Storage Configuration
      BATTERY_CAPACITY_MIN: ${BATTERY_CAPACITY_MIN:-10.0}
      BATTERY_CAPACITY_MAX: ${BATTERY_CAPACITY_MAX:-30.0}
      BATTERY_EFFICIENCY_MIN: ${BATTERY_EFFICIENCY_MIN:-0.90}
      BATTERY_EFFICIENCY_MAX: ${BATTERY_EFFICIENCY_MAX:-0.95}

      # Meter Type Distribution
      SOLAR_PROSUMER_RATIO: ${SOLAR_PROSUMER_RATIO:-0.40}
      GRID_CONSUMER_RATIO: ${GRID_CONSUMER_RATIO:-0.35}
      HYBRID_PROSUMER_RATIO: ${HYBRID_PROSUMER_RATIO:-0.20}
      BATTERY_STORAGE_RATIO: ${BATTERY_STORAGE_RATIO:-0.05}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - gridtokenx-network
    restart: unless-stopped

  # Mailpit SMTP Server (Development Email Testing)
  mailpit:
    image: axllent/mailpit:latest
    container_name: p2p-mailpit
    ports:
      - "${MAILPIT_SMTP_PORT:-1025}:1025" # SMTP server
      - "${MAILPIT_WEB_PORT:-8025}:8025" # Web UI
    environment:
      MP_MAX_MESSAGES: ${MP_MAX_MESSAGES:-5000}
      MP_DATABASE: ${MP_DATABASE:-/data/mailpit.db}
      MP_SMTP_AUTH_ACCEPT_ANY: ${MP_SMTP_AUTH_ACCEPT_ANY:-1}
      MP_SMTP_AUTH_ALLOW_INSECURE: ${MP_SMTP_AUTH_ALLOW_INSECURE:-1}
      TZ: ${TZ:-UTC}
    volumes:
      - mailpit_data:/data
    networks:
      - gridtokenx-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8025/api/v1/info" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # Anchor (Solana Development - Optional, for testing)
  # Uncomment if you need to run Anchor tests in Docker
  anchor:
    build:
      context: ./gridtokenx-anchor
      dockerfile: Dockerfile
    container_name: gridtokenx-anchor
    ports:
      - "${ANCHOR_RPC_PORT:-8899}:8899"
      - "${ANCHOR_WS_PORT:-8900}:8900"
    environment:
      # Solana Configuration
      SOLANA_RPC_URL: ${SOLANA_RPC_URL:-http://localhost:8899}
      SOLANA_WS_URL: ${SOLANA_WS_URL:-ws://localhost:8900}
    volumes:
      - ./gridtokenx-anchor:/app
      - anchor_cache:/root/.cache
    networks:
      - gridtokenx-network
    restart: unless-stopped

networks:
  gridtokenx-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  mailpit_data:
  anchor_cache:

@startuml
!include <C4/C4_Container>

title **GridTokenX Protocol Communication Matrix**

' Define styles
skinparam backgroundColor #FEFEFE
skinparam ArrowColor #666666
skinparam ArrowFontColor #333333

' ============================================
' CLIENT LAYER PROTOCOLS
' ============================================
System_Boundary(client, "Client Layer") {
    Container(browser, "Web Browser", "Client", "User agent executing Next.js SPA")
    Container(wallet_ext, "Wallet Extension", "Phantom/Solflare", "Browser extension for key management")
}

' ============================================
' FRONTEND PROTOCOLS
' ============================================
System_Boundary(frontend, "Frontend Protocols") {
    Container(trading_app, "Trading App", "Next.js", "SPA with React components")
    Container(wallet_adapter, "Wallet Adapter", "Solana Web3.js", "Wallet connection abstraction")
}

' ============================================
' NETWORK PROTOCOLS
' ============================================
System_Boundary(network, "Network Layer") {
    Container(api_gateway, "API Gateway", "Rust/Axum", "REST & WebSocket endpoint")
    Container(solana_rpc, "Solana RPC", "RPC Nodes", "Blockchain state access")
}

' ============================================
' EXTERNAL PROTOCOLS
' ============================================
System_Boundary(external, "External Services") {
    System_Ext(pyth, "Pyth Oracle", "Price feed provider")
    System_Ext(mapbox, "Mapbox GL", "Geospatial tiles")
}

' ============================================
' DATA PROTOCOLS
' ============================================
System_Boundary(data, "Data Layer") {
    ContainerDb(postgres, "PostgreSQL", "RDBMS", "Persistent storage")
    ContainerDb(redis, "Redis", "Cache", "Session & pub/sub")
    ContainerDb(influx, "InfluxDB", "Time-Series", "Telemetry metrics")
    ContainerQueue(kafka, "Kafka", "Event Stream", "Message broker")
    Container(simulator, "Smart Meter Sim", "Python/FastAPI", "Telemetry generator")
}

' ============================================
' PROTOCOL CONNECTIONS
' ============================================

' Client -> Frontend
Rel(browser, trading_app, "Page Load", "HTTPS (TLS 1.3)")
Rel(browser, wallet_ext, "DApp Connect", "Wallet Standard API")

' Frontend -> Network
Rel(trading_app, api_gateway, "API Calls", "HTTP/1.1, HTTP/2\nREST/JSON\nWebSocket (WSS)")
Rel(trading_app, solana_rpc, "Chain Queries", "JSON-RPC 2.0\nWebSocket (WSS)")
Rel(wallet_adapter, wallet_ext, "Sign Tx", "Wallet Standard\n(Solana Adapter)")

' Frontend -> External
Rel(trading_app, pyth, "Price Data", "HTTP/2 (REST)\nWebSocket (Real-time)")
Rel(trading_app, mapbox, "Map Tiles", "HTTPS (Vector Tiles)")

' Network -> Data
Rel(api_gateway, postgres, "SQL Queries", "PostgreSQL Wire Protocol\n(TCP port 5432)")
Rel(api_gateway, redis, "Cache/PubSub", "RESP (Redis Protocol)\n(TCP port 6379)")
Rel(api_gateway, kafka, "Event Stream", "Kafka Protocol\n(TCP port 9092)")

' Network -> Blockchain
Rel(api_gateway, solana_rpc, "Submit Tx", "JSON-RPC 2.0\ngRPC (internal)")

' Simulator -> Data
Rel(simulator, kafka, "Emit Telemetry", "Kafka Protocol\n(Protobuf/Avro)")
Rel(simulator, influx, "Write Metrics", "InfluxDB Line Protocol\n(HTTP API)")
Rel(simulator, postgres, "Read Config", "PostgreSQL Wire\n(psycopg2)")

' ============================================
' PROTOCOL LEGEND
' ============================================
legend right
  |=== Protocol | Port | Usage |
  | HTTPS | 443 | Secure web traffic |
  | HTTP/2 | 443 | Multiplexed requests |
  | WebSocket | 443 | Real-time bidirectional |
  | JSON-RPC | 443/8899 | Solana RPC calls |
  | PostgreSQL Wire | 5432 | Database queries |
  | RESP | 6379 | Redis commands |
  | Kafka Protocol | 9092 | Event streaming |
  | InfluxDB Line | 8086 | Time-series writes |
  |===

  **Security:**
  - All external traffic uses TLS 1.3
  - Internal traffic may use mTLS
  - JWT for API authentication
  - Ed25519 for Solana signatures
endlegend

footer GridTokenX Protocol Matrix | 2026
@enduml

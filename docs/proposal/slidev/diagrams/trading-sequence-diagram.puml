@startuml
!pragma teoz true

' ============================================================================
' GridTokenX - P2P Trading Sequence Diagram
' Core Market Mechanics: Order Placement, Escrow, and Atomic Settlement
' Version: 1.0
' ============================================================================

title <size:20>**GridTokenX - P2P Trading Sequence**</size>\nOrder Lifecycle & Trustless Settlement Flow



' Participants
actor "Energy Buyer\n(Consumer)" as Buyer
actor "Energy Seller\n(Prosumer)" as Seller

box "Frontend Layer"
    participant "Trading App\n//Next.js//" as FE
end box

box "Backend Layer"
    participant "API Gateway\n//Rust / Axum//" as API
    participant "Matching Engine\n//In-Memory//" as ME
end box

box "Solana Blockchain"
    participant "Trading Program\n//Anchor PDA//" as ANCHOR
    participant "SPL Token\n//Vaults//" as SPL
end box

database "PostgreSQL" as DB

' ============================================================================
' PHASE 1: ORDER PLACEMENT & ESCROW LOCKING
' ============================================================================
== <size:14>**â‘  Order Placement & Escrow Locking**</size> ==

autonumber "<b>[0]</b>"

Buyer -> FE : Place Buy Order\n(Price, Amount, Zone)
activate FE
FE -> API : POST /api/trading/orders\n{type: BUY, ...}
activate API

API -> DB : INSERT orders (status: PENDING)
activate DB
DB --> API : order_id
deactivate DB

API --> FE : Escrow Request\n{vault_pda, amount}
FE -> Buyer : Sign Escrow Transaction
Buyer -> FE : Signed Tx
FE -> ANCHOR : invoke: lock_funds\n{amount, order_id}
activate ANCHOR
ANCHOR -> SPL : Transfer USDC to Vault
activate SPL
SPL --> ANCHOR : Success
deactivate SPL
ANCHOR --> FE : Tx Signature
deactivate ANCHOR

FE -> API : POST /api/trading/confirm_escrow\n{tx_sig}
API -> DB : UPDATE orders (status: OPEN)
API -> ME : Add Order to Book
ME --> API : Added
API --> FE : Order Active
deactivate API
FE --> Buyer : Order Placed Successfully
deactivate FE

... Similarly for Seller (Energy Tokens locked in Escrow) ...

' ============================================================================
' PHASE 2: MATCHING & OPTIMIZATION
' ============================================================================
== <size:14>**â‘¡ High-Performance Matching**</size> ==

note over ME
  **Landed Cost Matching:**
  Sorts candidates by:
  Base Price + Zonal Loss + Wheeling
end note

ME -> ME : Execute Matching Cycle
ME -> API : Match Found!\n{buy_id, sell_id, qty, price}
activate API

' ============================================================================
' PHASE 3: ATOMIC SETTLEMENT
' ============================================================================
== <size:14>**â‘¢ Atomic Blockchain Settlement**</size> ==

API -> ANCHOR : invoke: settle_match\n{buy_order, sell_order}
activate ANCHOR

note over ANCHOR
  **Atomic Execution Guarantee:**
  All transfers must succeed or
  the entire matching reverts.
end note

ANCHOR -> SPL : CPI: Transfer GXT to Buyer
activate SPL
SPL --> ANCHOR : OK
deactivate SPL

ANCHOR -> SPL : CPI: Transfer USDC to Seller
activate SPL
SPL --> ANCHOR : OK
deactivate SPL

ANCHOR -> SPL : CPI: Collect Platform Fees
activate SPL
SPL --> ANCHOR : OK
deactivate SPL

ANCHOR --> API : Settlement Signature
deactivate ANCHOR

API -> DB : UPDATE orders (status: SETTLED)
API -> DB : INSERT trade_history
API --> FE : Real-time Notification (WebSocket)
activate FE
FE --> Buyer : ðŸ”” Energy Purchased!
FE --> Seller : ðŸ”” Energy Sold!
deactivate FE
deactivate API

' Footer
footer GridTokenX v2.0 | P2P Trading Lifecycle | 2026
@enduml

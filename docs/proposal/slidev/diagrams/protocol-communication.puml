@startuml
!include <C4/C4_Container>
!include <tupadr3/devicons/react>
!include <tupadr3/devicons/python>
!include <tupadr3/devicons/rust>
!include <tupadr3/devicons/postgresql>
!include <tupadr3/devicons/redis>
!include <tupadr3/font-awesome-5/server>
!include <tupadr3/font-awesome-5/link>
!include <tupadr3/font-awesome-5/coins>
!include <tupadr3/font-awesome-5/check_double>

skinparam defaultFontName "Helvetica Neue"
title **GridTokenX: Protocol Communication Mesh**\nVisualizing System-Wide Data Flows

' -- LEGEND --
' Customizing arrow styles for different protocols
skinparam arrow {
    Color #666666
    FontColor #666666
    FontSize 12
}

' -- NODES --

System_Boundary(clients, "Clients & Edge") {
    Container(browser, "Web App", "Next.js / React", "User Interface for Trading & Dashboard", $sprite="react")
    Container(iot_device, "Smart Meter", "IoT / Python Sim", "Generates energy telemetry", $sprite="python")
}

System_Boundary(backend, "Off-Chain Services") {
    Container(api_gateway, "API Gateway", "Rust / Axum", "Central logic & orchestration", $sprite="rust")
    Container(sim_engine, "Simulator Engine", "Python", "Orchestrates meter swarms", $sprite="python")
    
    ContainerDb(postgres, "PostgreSQL", "Relational DB", "User/Order persistence", $sprite="postgresql")
    ContainerDb(redis, "Redis", "Cache / PubSub", "Session & Hot State", $sprite="redis")
    ContainerQueue(kafka, "Apache Kafka", "Message Broker", "Telemetry Ingestion", $sprite="server")
}

System_Boundary(blockchain, "Solana Blockchain (L1)") {
    Container(rpc_node, "RPC Node", "Solana Validator", "Entry point for tx submission", $sprite="link")
    
    System_Boundary(programs, "Anchor Programs (On-Chain)") {
        Container(prog_oracle, "Oracle Program", "Anchor", "Validates Data", $sprite="check_double")
        Container(prog_registry, "Registry Program", "Anchor", "Identity & Assets")
        Container(prog_voting, "Governance Program", "Anchor", "DAO Config")
        Container(prog_trading, "Trading Program", "Anchor", "Matching & Settlement")
        Container(prog_token, "Energy Token", "Anchor", "Minting & SPL", $sprite="coins")
    }
}

' -- EDGES / PROTOCOLS --

' 1. Client -> Backend (HTTPS / WSS)
Rel(browser, api_gateway, "REST / WSS", "HTTPS/TLS")
Rel(iot_device, api_gateway, "Start/Stop Cmd", "HTTPS")

' 2. IoT -> Infrastructure (Kafka / Protocol)
Rel(iot_device, kafka, "Telemetry", "Kafka (TCP)")
Rel(sim_engine, kafka, "Batch Readings", "Kafka (TCP)")

' 3. Backend Internal (Rust / SQL / RESP)
Rel(api_gateway, postgres, "Query / Persist", "SQL (TCP)")
Rel(api_gateway, redis, "Cache / PubSub", "RESP (TCP)")
Rel(api_gateway, kafka, "Consume Events", "Kafka (TCP)")

' 4. Backend -> Blockchain (JSON-RPC)
Rel(api_gateway, rpc_node, "Send Transaction", "JSON-RPC (HTTPS)")
Rel(api_gateway, rpc_node, "Fetch Account State", "JSON-RPC (HTTPS)")

' 5. RPC -> Programs (Native Execution)
Rel(rpc_node, prog_oracle, "Execute Instruction", "Native")
Rel(rpc_node, prog_trading, "Execute Instruction", "Native")
Rel(rpc_node, prog_registry, "Execute Instruction", "Native")

' 6. On-Chain Inter-Program (CPI - Cross Program Invocation)
' Note: Using dotted lines or distinct color for CPI
Rel(prog_oracle, prog_registry, "Trigger Settlement", "CPI")
Rel(prog_registry, prog_token, "Mint Tokens", "CPI")
Rel(prog_trading, prog_token, "Transfer Assets", "CPI")
Rel(prog_voting, prog_registry, "Update Config", "CPI")

' Layout Hints
Lay_R(clients, backend)
Lay_R(backend, blockchain)

@enduml

@startuml matching_engine_trading
!include <tupadr3/font-awesome-5/user>
!include <tupadr3/font-awesome-5/gas_pump>
!include <tupadr3/font-awesome-5/coins>
!include <tupadr3/font-awesome-5/bolt>

title **GridTokenX - Matching Engine & Trading Lifecycle**

skinparam BoxPadding 10
skinparam ParticipantPadding 20
skinparam sequence {
    ArrowColor #2C3E50
    LifeLineBorderColor #2C3E50
    ParticipantBorderColor #34495E
    ParticipantBackgroundColor #ECF0F1
}

actor "<$bolt>\nSeller (Prosumer)" as seller
actor "<$user>\nBuyer (Consumer)" as buyer

box "Frontend Layer (Trading App)" #E8F8F5
    participant "UI Components" as ui
    participant "WASM OrderBook" as wasm
end box

box "Backend Layer (API Gateway)" #FEF9E7
    participant "Order Service" as api
    participant "Event Processor" as events
end box

box "Blockchain (Solana)" #F4ECF7
    participant "Trading Program" as program
    participant "SPL Token Program" as spl
end box

== Phase 1: Order Placement & Client-Side Preview ==

seller -> ui: Post Sell Order (Energy @ Price)
ui -> wasm: add_order(Sell, Price, Qty)
wasm -> wasm: Sort OrderBook (Price/Time)
wasm --> ui: Update Depth Chart & Estimate Match
ui --> seller: Display Preview & Sign Tx

seller -> api: Submit Signed Tx
api -> program: Instruction: create_sell_order
program -> program: Initialize Order PDA
program --> api: OrderCreated event
api --> ui: Order Confirmed
ui --> seller: Update Portfolio

== Phase 2: Order Matching (Triggered by Buyer) ==

buyer -> ui: Post Buy Order (Max Price)
ui -> wasm: match_orders(Buy, Price, Qty)
wasm -> wasm: Find Candidates (Price <= Bid)
wasm --> ui: Match Result Preview
ui --> buyer: Show Matching Candidates

buyer -> api: Submit Match/Buy Tx
api -> program: Instruction: match_orders(amount)

== Phase 3: On-Chain Settlement (Atomic) ==

group Atomic Execution Context
    program -> program: Verify Price Match (Bid >= Ask)
    program -> program: Validate Escrow Balances
    
    group Token Transfers (CPI)
        program -> spl: Transfer Energy (Seller -> Buyer)
        program -> spl: Transfer USDC (Buyer -> Seller)
        program -> spl: Transfer Fees (Buyer -> Treasury)
    end
    
    program -> program: Update Order Status (Partial/Completed)
    program -> program: Record Trade (TradeRecord PDA)
end

program --> events: Emit OrderMatched & TradeRecord Event
events -> api: Process Settlement Event
api -> ui: Push Real-time Update (WebSockets)

== Phase 4: Finalization ==

ui --> buyer: Display "Trade Successful"
ui --> seller: Display "Order Filled"

footer GridTokenX Trading Engine Flow | v2.1 | 2026
@enduml

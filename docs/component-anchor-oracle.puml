@startuml
!include <C4/C4_Component>
!include <tupadr3/font-awesome-5/broadcast_tower>
!include <tupadr3/font-awesome-5/chart_line>
!include <tupadr3/font-awesome-5/cog>

skinparam defaultFontName "Helvetica Neue"

title **Anchor Component: Oracle Program**\nData Validation & Market Triggers

Container(oracle, "Oracle Module", "Anchor Program", "Validates off-chain meter data and triggers market clearing.", $sprite="broadcast_tower")

System_Boundary(logic, "Instructions (Commands)") {
    Component(ix_init, "initialize", "Context<Initialize>", "Sets up oracle authority and default thresholds.")
    Component(ix_submit, "submit_meter_reading", "Context<SubmitReading>", "Ingests and validates energy data.")
    Component(ix_trigger, "trigger_market_clearing", "Context<TriggerClearing>", "Signals the start of a settlement cycle.")
    
    Component(ix_status, "update_oracle_status", "Context<UpdateStatus>", "Activates/Deactivates oracle operations.")
    Component(ix_config, "update_validation_config", "Context<UpdateConfig>", "Adjusts min/max values and deviation limits.")
    Component(ix_gateway, "update_api_gateway", "Context<UpdateGateway>", "Rotates the authorized API Gateway key.")
    
    Component(ix_backup, "add/remove_backup", "Context<ManageBackup>", "Manages fallback oracle providers.")
}

System_Boundary(state, "Program State (PDAs)") {
    ComponentDb(acc_data, "Oracle Data", "Account<OracleData>", "Seeds: ['oracle_data']\nGlobal stats, config, and validation metrics.", $sprite="chart_line")
}

' External
System_Ext(gateway, "API Gateway", "Signer", "Off-chain service pushing data.")
System_Ext(admin, "Admin Authority", "Signer", "Platform administrator.")

' Relationships
Rel(admin, ix_init, "Initialize", "RPC")
Rel(admin, ix_config, "Tune Params", "RPC")
Rel(admin, ix_status, "Set Active", "RPC")
Rel(admin, ix_gateway, "Authorize Gateway", "RPC")

Rel(gateway, ix_submit, "Push Telemetry", "Keypair Sign")
Rel(gateway, ix_trigger, "Start Clearing", "Keypair Sign")

Rel(ix_init, acc_data, "Create", "Write")
Rel(ix_config, acc_data, "Update Config", "Write")
Rel(ix_submit, acc_data, "Validate & Update Stats", "Read/Write")
Rel(ix_trigger, acc_data, "Update Timestamp", "Write")

' Layout
Lay_R(logic, state)

@enduml

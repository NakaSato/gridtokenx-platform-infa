@startuml core_minting_program
!include <C4/C4_Container>
!include <tupadr3/font-awesome-5/server>
!include <tupadr3/font-awesome-5/coins>
!include <tupadr3/font-awesome-5/database>
!include <tupadr3/font-awesome-5/check>

title **Core Minting Program (Anchor/Solana)**\nInstruction: settle_and_mint_tokens()

' Layout Control
LAYOUT_TOP_DOWN()
skinparam linetype ortho
skinparam defaultFontSize 14

' Participants
System_Boundary(core_program, "Registry Program (Logic)") {
    Container(instruction, "settle_and_mint_tokens()", "Anchor Entry Point", $sprite="server")
    
    System_Boundary(logic, "Internal Process") {
        Container(validate, "Validation", "require! checks", $sprite="check")
        Container(calculate, "Calculation", "net - settled", $sprite="coins")
        Container(update, "State Update", "settled += amount", $sprite="database")
        Container(cpi, "CPI Prep", "Signer Seeds", $sprite="server")
    }
}

Boundary(accounts, "State Management (PDAs)") {
    ContainerDb(meter, "Meter Account", "Storage: Generation/Settled", $sprite="database")
    ContainerDb(registry, "Registry Authority", "Signer / PDA bump", $sprite="database")
}

Boundary(external, "Token Layer (SPL)") {
    Container(energy_token, "SPL Token Program", "Target Program", $sprite="server")
    ContainerDb(mint, "GRX Mint", "Global Supply", $sprite="coins")
    ContainerDb(ata, "User ATA", "Recipient Balance", $sprite="database")
}

' Flow Relationships
Rel_D(instruction, validate, "1. Call")
Rel_D(validate, calculate, "2. Proceed")
Rel_D(calculate, update, "3. Update")
Rel_D(update, cpi, "4. Prepare")

' Account Interactions
Rel_L(validate, meter, "Verify Status/Owner")
Rel_L(calculate, meter, "Read Generation")
Rel_L(update, meter, "Write Settled")

' Cross-Program Flow
Rel_R(cpi, registry, "Derive Seeds")
Rel_R(cpi, energy_token, "Invoke Mint")

Rel_D(energy_token, mint, "Increase Supply")
Rel_D(energy_token, ata, "Credit Funds")

' Annotations
note left of validate
  **Validation Check:**
  - Status == Active
  - Signer == Owner
  - Mintable > 0
end note

note right of energy_token
  **CPI Action:**
  Executes secure
  mint_to instruction
  held by Registry authority.
end note

footer GridTokenX Architecture | Core Minting Logic | 2026
@enduml

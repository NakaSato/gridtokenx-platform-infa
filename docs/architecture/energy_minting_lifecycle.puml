@startuml energy_minting_lifecycle
!include <C4/C4_Container>
!include <tupadr3/font-awesome-5/solar_panel>
!include <tupadr3/font-awesome-5/microchip>
!include <tupadr3/font-awesome-5/link>
!include <tupadr3/font-awesome-5/coins>
!include <tupadr3/font-awesome-5/user>

title **GridTokenX: Energy-to-Token Minting Lifecycle**\nEnd-to-End Orchestration Flow

' Layout Control
LAYOUT_LEFT_RIGHT()

' Participants
Boundary(physical_layer, "Physical Layer (Edge)") {
    System(smart_meter, "Smart Meter (IoT)", "Simulator", "Captures real-time generation metrics (kWh).", $sprite="microchip")
}

Boundary(integration_layer, "Integration Layer (Oracle)") {
    Container(api_gateway, "GridTokenX API Gateway", "Rust / Actix", "Aggregates meter data and submits signed transactions to Solana.")
}

Boundary(blockchain_layer, "Blockchain Layer (Solana)") {
    Container(registry, "Registry Program", "Anchor PDA Logic", "Manages Meter state and calculates mintable balances.")
    Container(energy_token, "Energy Token Program", "SPL Logic", "Executes secure token minting via CPI.")
}

Boundary(user_layer, "Value Layer (Settlement)") {
    ContainerDb(user_wallet, "User Wallet (ATA)", "SPL Token Account", "Holds $GRX (GridToken Energy Units).", $sprite="coins")
    Person(prosumer, "Prosumer", "Energy Producer", $sprite="user")
}

' Flow
Rel_R(smart_meter, api_gateway, "Meter Readings (kWh)", "Secure JSON RPC")
Rel_R(api_gateway, registry, "Update Meter State", "Blockchain Transaction")

Rel_R(registry, energy_token, "settle_and_mint()", "Cross-Program Invoke (CPI)")
Rel_R(energy_token, user_wallet, "Mint $GRX Tokens", "SPL Token Minting")
Rel_D(user_wallet, prosumer, "Credit Value", "Direct Ownership")

' Technical Notes
note top of api_gateway
  **Oracle Role:**
  The Gateway acts as a 
  trusted bridge, signing 
  proof-of-generation data.
end note

note bottom of registry
  **Minting Logic:**
  Mintable = Net Generation 
             - Already Settled
end note

footer GridTokenX Architecture | Minting Lifecycle | 2026
@enduml

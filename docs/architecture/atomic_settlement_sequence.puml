@startuml atomic_settlement_sequence
!include <C4/C4_Sequence>

title **Atomic Settlement Sequence**

skinparam dpi 400
skinparam defaultFontSize 14
skinparam SequenceMessageAlignment center

' Participants
Participant "Buyer" as buyer
Participant "Buyer Escrow" as buyer_escrow
Participant "Settlement\nSmart Contract" as settlement
Participant "Seller Escrow" as seller_escrow
Participant "Seller" as seller
Participant "Fee Pool" as fee_pool

' Phase 1: Locking (Pre-trade)
buyer -> buyer_escrow: Lock Token
& seller -> seller_escrow: Lock GRX
note right: Parallel execution\n(Solana confirmation)

' Phase 2: Settlement Trigger
buyer_escrow -> settlement: Token Available
& seller_escrow -> settlement: GRX Available
note right: Event emission

' Phase 3: Atomic Execution (Critical Path)
settlement -> settlement: Validate balances
note right: Account validation

settlement -> settlement: Check price oracle
note right: Oracle read

settlement -> seller: Transfer Token
note right: SPL Token transfer

settlement -> buyer: Transfer GRX
note right: SPL Token transfer (parallel)

settlement -> fee_pool: Deduct fees
note right: Fee calculation & transfer

' Phase 4: Confirmation
settlement --> buyer: Success callback
& settlement --> seller: Success callback
note right: Event confirmation

' Summary box
note over buyer, fee_pool
  **Atomic Settlement Complete**
  
  • All operations succeed together
  • Or all revert on any failure
  • No partial execution possible
end note

footer GridTokenX | Atomic Settlement Sequence | 2026
@enduml

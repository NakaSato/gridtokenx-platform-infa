@startuml
!pragma teoz true



title <size:18>**Transaction Atomicity & Security Flow**</size>\nTrustless P2P Settlement Execution

box "Middleware"
    participant "API Gateway\n(Rust Signer)" as Gateway
end box

box "Solana Network"
    participant "Escrow Program\n(Anchor PDA)" as Escrow
    participant "User Wallets\n(SPL Accounts)" as Wallets
end box

== <size:14>Atomic Settlement Process</size> ==

autonumber "<b>[00]</b>"

Gateway -> Escrow : match_orders(buy_pda, sell_pda)
activate Gateway
activate Escrow

note over Escrow
    **On-Chain Security Core:**
    1. Verify Platform Signature
    2. Check Buyer Balance (USDC)
    3. Check Seller Balance (GXT)
    4. Validate Price Integrity
end note

group Atomic Instructions (One Transaction)
    Escrow -> Wallets : Transfer GXT to Buyer
    Wallets -> Wallets : Update Ledger State
    
    Escrow -> Wallets : Transfer USDC to Seller
    Wallets -> Wallets : Update Ledger State
    
    Escrow -> Wallets : Pay Platform Fee
    Wallets -> Wallets : Update Ledger State
end

note right of Escrow
    **Atomicity Guarantee:**
    If any transfer fails (e.g., 
    insufficient funds), the 
    ENTIRE transaction reverts. 
    No partial trades possible.
end note

Escrow -->> Gateway : Success (Finality Confirmation)
deactivate Escrow

Gateway -> Gateway : Mark Match as SETTLED
Gateway -->> Wallets : Notify Update via WebSocket

deactivate Gateway

footer GridTokenX v2.0 | Transaction Security Protocol | 2026
@enduml

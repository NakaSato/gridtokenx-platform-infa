@startuml
!include <C4/C4_Container>
!include <tupadr3/devicons/rust>
!include <tupadr3/devicons/postgresql>
!include <tupadr3/font-awesome-5/coins>
!include <tupadr3/font-awesome-5/check_circle>

' Visual Configuration
skinparam defaultFontName "Helvetica Neue"
skinparam defaultFontSize 14
skinparam roundCorner 8
skinparam shadowing false
skinparam backgroundColor #FFFFFF

title **Advanced Architectural View: Dual-State Consistency Model**\nBridging High-Speed Execution with On-Chain Finality

' Component Definitions
Person(user, "User / Trader", "Energy participant placing orders.")

System_Boundary(middleware, "High-Speed Memory Tier (Middleware)") {
    Container(me, "Matching Engine", "Rust / Tokio", "Handles sub-millisecond price discovery and order matching.", $sprite="rust")
    ContainerDb(pg, "Status Cache", "PostgreSQL", "Optimized view of order book and prosumer state.", $sprite="postgresql")
}

System_Boundary(consensus, "Finality Layer (Solana Blockchain)") {
    Container(escrow, "Escrow Program", "Anchor / SPL", "Trustless vault for tokens and currency in-flight.", $sprite="coins")
    Container(on_chain_state, "Decentralized State", "L1 Consensus", "The single source of truth for global ownership.", $sprite="check_circle")
}

' Interactions
Rel(user, me, "Submits Order", "WebSocket / HMAC")
Rel(me, pg, "Write-Through Cache", "Atomic Update")
Rel(me, pg, "Optimistic Lock", "SQL Transaction")

Rel(me, escrow, "Trigger Atomic Settlement", "JSON RPC (Signed)")
Rel_D(escrow, on_chain_state, "Consensus Finality", "Slot Confirmation")
Rel_Neighbor(on_chain_state, pg, "Sync Worker", "Event Listening (WSS)")

' Key Explanatory Notes
note top of me #FFF9C4
  **Why Dual-State?**
  1. **Latency**: Blockchain ≈ 400ms. 
     Rust Middleware ≈ 1ms.
  2. **Cost**: Off-chain matching 
     saves transaction fees.
  3. **Reliability**: Atomic sync 
     prevents double-spending.
end note

note bottom of escrow #E8F5E9
  **Trust Model:**
  User tokens are NEVER stored 
  on our servers. They moved 
  directly from PDA to PDA 
  via platform oversight.
end note

footer GridTokenX v2.0 | Hybrid Architectural Design | 2026
@enduml

@startuml
!include <C4/C4_Container>
!include <tupadr3/devicons/react>
!include <tupadr3/devicons/rust>
!include <tupadr3/devicons/postgresql>
!include <tupadr3/devicons/redis>
!include <tupadr3/font-awesome-5/coins>
!include <tupadr3/font-awesome-5/user>
!include <tupadr3/font-awesome-5/broadcast_tower>
!include <tupadr3/font-awesome-5/map>

skinparam defaultFontName "Helvetica Neue"

title **GridTokenX - Trading Container View**\nUser Interactions & Token Settlement

' Person
Person(user, "Prosumer", "Energy producer/consumer managing wallet and placing orders.", $sprite="user")

System_Boundary(platform, "GridTokenX Platform") {

    System_Boundary(frontend_layer, "Frontend Layer") {
        Container(trading_app, "Trading Dashboard", "Next.js, React", "Interface for market trading and portfolio management.", $sprite="react")
    }

    System_Boundary(backend_layer, "Service Layer") {
        Container(gateway, "API Gateway", "Rust, Axum", "Handles order matching, session auth, and blockchain orchestration.", $sprite="rust")
    }

    System_Boundary(data_layer, "Persistence") {
        ContainerDb(cache, "Session Cache", "Redis", "Fast session storage and order book caching.", $sprite="redis")
        ContainerDb(db, "Primary DB", "PostgreSQL", "Relational storage for user profiles and order history.", $sprite="postgresql")
    }

    System_Boundary(blockchain_layer, "Blockchain Layer") {
        Container(blockchain, "Solana Network", "Anchor Framework", "Executes atomic listing, matching, and settlement.", $sprite="coins")
    }
}

' External Systems
System_Ext(pyth, "Pyth Network", "Oracle price feeds.", $sprite="broadcast_tower")
System_Ext(mapbox, "Mapbox", "Grid topology maps.", $sprite="map")

' Trading Flows
Rel_D(user, trading_app, "Places Orders / Connects Wallet", "HTTPS")

Rel_D(trading_app, gateway, "Submit Order", "REST / WSS")
Rel_R(trading_app, mapbox, "View Grid Map", "HTTPS")
Rel_D(trading_app, blockchain, "Sign Transactions", "RPC")

Rel_D(gateway, db, "Persist Orders", "SQL")
Rel_D(gateway, cache, "Cache Orderbook", "RESP")
Rel_R(gateway, blockchain, "Verify Settlement", "RPC")
Rel_R(gateway, pyth, "Get Energy Price", "HTTPS")

' Layout hints
Lay_R(frontend_layer, pyth)
Lay_D(frontend_layer, backend_layer)
Lay_D(backend_layer, data_layer)
Lay_R(gateway, blockchain_layer)

@enduml

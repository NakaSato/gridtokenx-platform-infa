@startuml layer2-poa-governance
!include <C4/C4_Component>

skinparam defaultFontName "Helvetica Neue"
title **Layer 2: Application Governance (PoA)**\nAdmin Keys & On-Chain Access Control

' -- NODES --

System_Ext(admin_key, "Authority", "Ed25519 Keypair", "The only entity with 'Admin' privileges")

System_Boundary(anchor_governance, "Governance Program (The Gatekeeper)") {
    Component(gov_ix, "Instruction Handler", "Anchor Logic", "Entrypoint for Admin Ops")
    ComponentDb(poa_config, "PoA Config", "PDA State", "Stores 'Authority' Pubkey & Flags")
}

System_Boundary(anchor_registry, "Registry Program (Protected)") {
    Component(reg_ix, "Registration Logic", "Anchor Logic", "Creates PDAs for Users/Meters")
    ComponentDb(meter_pda, "Meter Registry", "PDA State", "Identity & Energy Stats")
}

System_Boundary(anchor_oracle, "Oracle Program (Protected)") {
    Component(oracle_ix, "Data Ingestion", "Anchor Logic", "Validates Telemetry Stream")
    ComponentDb(oracle_config, "Oracle Config", "PDA State", "Whitelisted Feeders")
}

' -- FLOW --

' 1. Authentication
Rel(admin_key, gov_ix, "1. Sign & Submit Transaction", "Solana Tx")
Rel(gov_ix, poa_config, "2. Verify Signer == Authority", "Read State")

' 2. Registry Control
Rel(gov_ix, reg_ix, "3. Invoke 'Register Meter' (CPI)", "Signed with Program Seeds")
Rel(reg_ix, meter_pda, "4. Initialize Account", "Write PDA")

' 3. Oracle Control
Rel(gov_ix, oracle_ix, "5. Invoke 'Update Config' (CPI)", "Signed with Program Seeds")
Rel(oracle_ix, oracle_config, "6. Update Whitelist", "Write PDA")

' Note on Protection
note right of reg_ix
    Only accepts CPI from
    Governance Program
end note

' Layout
Lay_R(anchor_governance, anchor_registry)
Lay_D(anchor_registry, anchor_oracle)

@enduml

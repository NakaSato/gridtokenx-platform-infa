@startuml
!include <C4/C4_Sequence>

skinparam defaultFontName "Helvetica Neue"
title **GridTokenX: P2P Trading Cycle**\nOrder Matching & Atomic Settlement

actor "Seller (Prosumer)" as Seller
actor "Buyer (Consumer)" as Buyer
participant "Trading Program" as Trading
participant "Energy Token" as GXT
participant "SPL Token (USDC)" as USDC
entity "Market PDA" as Market
entity "Order PDA" as Order
entity "Escrow Vault" as Escrow

== Place Sell Order ==
Seller -> Trading: **create_sell_order(amount, price)**
activate Trading
Trading -> GXT: Transfer GXT Owner -> Escrow
Trading -> Order: Init PDA (Sell Side)
Trading -> Market: Update Depth Chart
Trading --> Seller: Order Created
deactivate Trading

== Place Buy Order ==
Buyer -> Trading: **create_buy_order(amount, max_price)**
activate Trading
Trading -> USDC: Transfer USDC Owner -> Escrow
Trading -> Order: Init PDA (Buy Side)
Trading -> Market: Update Depth Chart
Trading --> Buyer: Order Created
deactivate Trading

== Matching Engine (Off-Chain Trigger) ==
participant "Matching Bot" as Matcher
Matcher -> Trading: **match_orders(buy_id, sell_id)**
activate Trading
Trading -> Order: Verify Price Overlap
Trading -> Market: Calculate VWAP Price
Trading -> Order: Update Status (PartiallyFilled)
Trading --> Matcher: Match Recorded
deactivate Trading

== Atomic Settlement ==
Matcher -> Trading: **execute_atomic_settlement()**
activate Trading
Trading -> USDC: **Transfer USDC Escrow -> Seller** (Net Proceeds)
Trading -> USDC: Transfer USDC Escrow -> FeeCollector (Platform Fee)
Trading -> GXT: **Transfer GXT Escrow -> Buyer**
Trading -> Order: Mark Completed / Closed
Trading --> Matcher: Settled
deactivate Trading

@enduml

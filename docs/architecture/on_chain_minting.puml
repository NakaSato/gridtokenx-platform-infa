@startuml on_chain_minting
!include <C4/C4_Component>
!include <tupadr3/font-awesome-5/server>
!include <tupadr3/font-awesome-5/coins>
!include <tupadr3/font-awesome-5/database>
!include <tupadr3/font-awesome-5/check>

title **On-Chain Minting Flow (Anchor Programs)**

skinparam defaultFontSize 13
skinparam linetype ortho

' Color scheme
skinparam BackgroundColor #FAFAFA
skinparam ComponentBackgroundColor #FFFFFF
skinparam ComponentBorderColor #6366F1
skinparam ComponentFontColor #1F2937
skinparam ComponentBorderThickness 2
skinparam DatabaseBackgroundColor #F3F4F6
skinparam DatabaseBorderColor #8B5CF6
skinparam DatabaseFontColor #1F2937
skinparam BoundaryBackgroundColor #F9FAFB
skinparam BoundaryBorderColor #9CA3AF
skinparam BoundaryBorderStyle dashed

' === REGISTRY PROGRAM ===
System_Boundary(registry_program, "Registry Program (Anchor)") {
    Component(entry, "settle_and_mint_tokens()", "Instruction Handler", $sprite="server")
    
    Component(val_status, "Validate: meter.status == Active", "require!", $sprite="check")
    Component(val_owner, "Validate: signer == meter.owner", "require_keys_eq!", $sprite="check")
    Component(val_amount, "Validate: mintable > 0", "require!", $sprite="check")
    
    Component(calc, "Calculate Mintable", "net_generation - settled_net", $sprite="coins")
    Component(update, "Update Meter State", "meter.settled_net += amount", $sprite="database")
    Component(event, "emit! MeterBalanceSettled", "Event Log", $sprite="server")
    
    Component(cpi, "CPI: mint_tokens_direct()", "Cross-Program Invoke", $sprite="server")
}

' === ENERGY TOKEN PROGRAM ===
System_Boundary(energy_token_program, "Energy Token Program (SPL)") {
    Component(mint_handler, "mint_tokens_direct()", "CPI Handler", $sprite="server")
    Component(auth_check, "Verify Registry Authority", "Signer validation", $sprite="check")
    Component(mint_to, "mint_to()", "SPL Token mint", $sprite="coins")
}

' === ACCOUNTS ===
System_Boundary(accounts, "On-Chain Accounts") {
    ContainerDb(meter, "Meter Account", "PDA - Stores generation/consumption", $sprite="database")
    ContainerDb(registry_pda, "Registry PDA", "Signer - Mint authority", $sprite="database")
    ContainerDb(token_info, "Token Info", "PDA - Mint config", $sprite="database")
    ContainerDb(grx_mint, "GRX Mint", "SPL Mint Account", $sprite="coins")
    ContainerDb(user_ata, "User ATA", "Associated Token Account", $sprite="database")
}

' === FLOW ===
' Entry point
Rel(entry, meter, "1. Deserialize", "ctx.accounts.meter_account")

' Validation chain
Rel(entry, val_status, "2. Check meter active")
Rel(val_status, val_owner, "3. Check ownership")
Rel(val_owner, calc, "4. Load & calculate")

' Calculation
Rel(calc, meter, "4a. Read net_generation")
Rel(calc, val_amount, "5. Verify mintable > 0")

' State update
Rel(val_amount, update, "6. Update settled balance")
Rel(update, meter, "6a. Store new value")
Rel(update, event, "7. Emit event")

' CPI to Energy Token
Rel(event, cpi, "8. Prepare CPI")
Rel(cpi, registry_pda, "8a. Derive signer seeds")
Rel(cpi, energy_token_program, "9. Invoke CPI")

' Energy Token flow
Rel(energy_token_program, mint_handler, "10. Handle CPI")
Rel(mint_handler, token_info, "11. Verify authority")
Rel(token_info, registry_pda, "11a. Check signer")
Rel(mint_handler, auth_check, "12. Auth passed")

' Mint tokens
Rel(auth_check, mint_to, "13. Execute mint")
Rel(mint_to, grx_mint, "13a. Increase supply")
Rel(mint_to, user_ata, "14. Credit tokens")

' Return
Rel(energy_token_program, registry_pda, "15. Return OK")

' === ANNOTATIONS ===
note right of entry
  **Entry Accounts:**
  - meter_account: Meter state
  - registry: PDA signer
  - token_info: Mint authority
  - mint: GRX mint
  - user_token_account: Recipient
  - energy_token_program: CPI target
end note

note bottom of calc
  **Mintable Calculation:**
  ```rust
  let mintable = meter.net_generation 
               - meter.settled_net_generation;
  require!(mintable > 0);
  ```
end note

note right of cpi
  **CPI Accounts:**
  - registry: Signer (PDA)
  - token_info: Authority check
  - mint: GRX token mint
  - user_token_account: Recipient
  - token_program: SPL Token
end note

footer GridTokenX v2.0 | On-Chain Minting (Anchor/Solana) | 2026
@enduml

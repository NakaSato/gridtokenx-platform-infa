@startuml anchor_minting
!include <C4/C4_Component>

title **Anchor Program - settle_and_mint_tokens()**

skinparam defaultFontSize 14
skinparam linetype ortho

' Modern professional color scheme
skinparam BackgroundColor #FAFAFA
skinparam ComponentBackgroundColor #FFFFFF
skinparam ComponentBorderColor #6366F1
skinparam ComponentFontColor #1F2937
skinparam ComponentBorderThickness 2
skinparam DatabaseBackgroundColor #F3F4F6
skinparam DatabaseBorderColor #8B5CF6
skinparam DatabaseFontColor #1F2937
skinparam BoundaryBackgroundColor #F9FAFB
skinparam BoundaryBorderColor #9CA3AF
skinparam BoundaryBorderStyle dashed

LAYOUT_TOP_DOWN()

' Program entry
Component(entry, "settle_and_mint_tokens(), Registry Program")

' Validation phase
Component(v1, "require! - meter.status == Active")
Component(v2, "require_keys_eq! - meter_owner == meter.owner")
Component(v3, "require! - new_tokens_to_mint > 0")

' Calculation
Component(calc, "Calculate net generation and mintable amount")

' State update
Component(update, "Update meter.settled_net_generation")

' Event
Component(event, "emit! MeterBalanceSettled")

' CPI Preparation
Component(cpi_prep, "Prepare CPI accounts")
Component(seeds, "Derive signer_seeds - b/registry + bump")

' CPI Call
Component(cpi, "energy_token::cpi::mint_tokens_direct()")

' Accounts involved
ContainerDb(acc1, "ctx.accounts.meter_account")
ContainerDb(acc2, "ctx.accounts.registry - PDA Signer")
ContainerDb(acc3, "ctx.accounts.token_info")
ContainerDb(acc4, "ctx.accounts.mint - GRX Mint")
ContainerDb(acc5, "ctx.accounts.user_token_account - Recipient ATA")
ContainerDb(acc6, "ctx.accounts.energy_token_program")

' Flow
entry -> v1: Validate meter status
v1 -> v2: Validate ownership
v2 -> calc: Load meter and calculate
calc -> v3: Check mintable > 0
v3 -> update: Update settled balance
update -> event: Emit settlement event
event -> cpi_prep: Prepare CPI accounts
cpi_prep -> seeds: Derive PDA signer
seeds -> cpi: Execute mint_tokens_direct

footer GridTokenX | Anchor settle_and_mint_tokens() | 2026
@enduml

@startuml solana-sealevel-runtime
!include <C4/C4_Component>

skinparam defaultFontName "Helvetica Neue"
title **Solana Sealevel Runtime**\nParallel Execution & Account Locking Model

' -- NODES --

System_Ext(client, "RPC / Client", "Submits signed transactions")

System_Boundary(validator, "Solana Validator (Leader Node)") {
    
    Component(tpu, "Transaction Processing Unit", "UDP / QUIC", "Ingests and SigVerify")
    
    Component(scheduler, "Banking Stage (Scheduler)", "Rust", "Sorts Tx by Account Locks (Read/Write)")
    
    System_Boundary(sealevel, "Sealevel Parallel Runtime") {
        Component(thread_1, "Execution Thread 1", "SBF VM", "Process Batch A (Non-overlapping)")
        Component(thread_2, "Execution Thread 2", "SBF VM", "Process Batch B (Non-overlapping)")
        Component(thread_3, "Execution Thread 3", "SBF VM", "Process Batch C (Non-overlapping)")
        Component(thread_4, "Execution Thread 4", "SBF VM", "Process Batch D (Non-overlapping)")
    }
    
    ComponentDb(accounts_db, "AccountsDB", "Memory Mapped SSD", "Persistent State (Merkle Root)")
    
    System_Boundary(programs, "Anchor Programs (Logic)") {
        Component(prog_logic, "Program Logic", "BPF / ELF", "Stateless Instructions")
    }
}

' -- FLOW --

Rel(client, tpu, "1. Send Transaction (Ed25519 Signed)", "UDP/QUIC")
Rel(tpu, scheduler, "2. Forward Verified Packets", "Stream")

Rel(scheduler, thread_1, "3a. Schedule Batch", "Write Lock: Acc A")
Rel(scheduler, thread_2, "3b. Schedule Batch", "Write Lock: Acc B")
Rel(scheduler, thread_3, "3c. Schedule Batch", "Write Lock: Acc C")
Rel(scheduler, thread_4, "3d. Schedule Batch", "Write Lock: Acc D")

Rel_U(thread_1, prog_logic, "4. Load Code", "ELF")
Rel_U(thread_2, prog_logic, "4. Load Code", "ELF")

Rel_D(thread_1, accounts_db, "5. Read/Write State", "SIMD")
Rel_D(thread_2, accounts_db, "5. Read/Write State", "SIMD")
Rel_D(thread_3, accounts_db, "5. Read/Write State", "SIMD")
Rel_D(thread_4, accounts_db, "5. Read/Write State", "SIMD")

' Layout
Lay_D(scheduler, sealevel)
Lay_D(sealevel, accounts_db)

@enduml

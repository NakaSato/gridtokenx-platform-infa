services:
  # PostgreSQL Database for API Gateway
  postgres:
    image: postgres:17-alpine
    container_name: gridtokenx-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      TZ: ${TZ}
    command:
      - "postgres"
      - "-c"
      - "max_connections=100"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "work_mem=16MB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "log_statement=mod"
      - "-c"
      - "log_duration=on"
      - "-c"
      - "log_min_duration_statement=1000"
      - "-c"
      - "shared_preload_libraries=pg_stat_statements"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - gridtokenx-network
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache for API Gateway
  redis:
    image: redis:7-alpine
    container_name: gridtokenx-redis
    environment:
      TZ: ${TZ}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - gridtokenx-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5

  # InfluxDB Time Series Database
  influxdb:
    image: influxdb:2.7-alpine
    container_name: gridtokenx-influxdb
    ports:
      - "${INFLUXDB_PORT}:8086"
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUXDB_USER}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUXDB_PASSWORD}
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUXDB_ORG}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUXDB_BUCKET}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUXDB_TOKEN}
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
    networks:
      - gridtokenx-network
    restart: unless-stopped
    healthcheck:
      test: "curl -f http://localhost:8086/health || exit 1"
      interval: 30s
      timeout: 10s
      retries: 5

  # Kafka Message Broker (KRaft Mode - No Zookeeper)
  kafka:
    image: apache/kafka:3.7.0
    container_name: gridtokenx-kafka
    ports:
      - "${KAFKA_PORT:-9092}:9092"
    environment:
      TZ: ${TZ}
      # KRaft Configuration (No Zookeeper needed)
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      # Topic Configuration
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      # Performance Tuning
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      # Cluster ID for KRaft
      CLUSTER_ID: "MkU3OEVBNTcwNTJENDM2Qk"
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - gridtokenx-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # API Gateway (Rust/Axum)
  apigateway:
    build:
      context: .
      dockerfile: gridtokenx-apigateway/Dockerfile
    container_name: gridtokenx-apigateway
    ports:
      - "${APIGATEWAY_PORT}:4000"
    volumes:
      - ./dev-wallet.json:/app/dev-wallet.json
    environment:
      # Application Configuration
      TZ: ${TZ}
      PORT: ${PORT}
      SERVER_HOST: ${SERVER_HOST}
      SERVER_PORT: ${SERVER_PORT}
      ENVIRONMENT: ${ENVIRONMENT}
      RUST_LOG: ${RUST_LOG}
      LOG_LEVEL: ${LOG_LEVEL}
      LOG_FORMAT: ${LOG_FORMAT}
      AUDIT_LOG_ENABLED: ${AUDIT_LOG_ENABLED}
      TEST_MODE: ${TEST_MODE}

      # Database Configuration
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      MAX_CONNECTIONS: ${MAX_CONNECTIONS}
      MIN_CONNECTIONS: ${MIN_CONNECTIONS}
      DATABASE_MAX_CONNECTIONS: ${DATABASE_MAX_CONNECTIONS}
      DATABASE_MIN_CONNECTIONS: ${DATABASE_MIN_CONNECTIONS}

      # Redis Configuration
      REDIS_URL: redis://redis:${REDIS_PORT}
      REDIS_POOL_SIZE: ${REDIS_POOL_SIZE}
      REDIS_MAX_CONNECTIONS: ${REDIS_MAX_CONNECTIONS}
      REDIS_CONNECTION_TIMEOUT: ${REDIS_CONNECTION_TIMEOUT}
      REDIS_COMMAND_TIMEOUT: ${REDIS_COMMAND_TIMEOUT}
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT}

      # InfluxDB Configuration
      INFLUXDB_URL: ${INFLUXDB_URL}
      INFLUXDB_TOKEN: ${INFLUXDB_TOKEN}
      INFLUXDB_ORG: ${INFLUXDB_ORG}
      INFLUXDB_BUCKET: ${INFLUXDB_BUCKET}

      # Smart Meter Simulator Configuration (for P2P cost calculation)
      SIMULATOR_URL: ${SIMULATOR_URL}

      # Solana Blockchain Configuration
      SOLANA_RPC_URL: http://host.docker.internal:8899
      SOLANA_WS_URL: ws://host.docker.internal:8900
      SOLANA_CLUSTER: ${SOLANA_CLUSTER}
      TOKENIZATION_ENABLE_REAL_BLOCKCHAIN: "true"

      # Program IDs
      REGISTRY_PROGRAM_ID: ${REGISTRY_PROGRAM_ID}
      ENERGY_TOKEN_PROGRAM_ID: "HaT3koMseafcCB9aUQUCrSLMDfN1km7Xik9UhZSG9UV6"
      TRADING_PROGRAM_ID: ${TRADING_PROGRAM_ID}
      ORACLE_PROGRAM_ID: ${ORACLE_PROGRAM_ID}
      GOVERNANCE_PROGRAM_ID: ${GOVERNANCE_PROGRAM_ID}
      ENERGY_TOKEN_MINT: ${ENERGY_TOKEN_MINT}
      ENGINEERING_KEYPAIR_PATH: ${ENGINEERING_KEYPAIR_PATH}
      ORACLE_KEYPAIR_PATH: ${ORACLE_KEYPAIR_PATH}
      ENGINEERING_DEPT_KEYPAIR_PATH: ${ENGINEERING_DEPT_KEYPAIR_PATH}

      # Authentication & Security
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION}
      API_KEY_SECRET: ${API_KEY_SECRET}
      ENGINEERING_API_KEY: ${ENGINEERING_API_KEY}
      HMAC_SECRET: ${HMAC_SECRET}
      ENCRYPTION_SECRET: ${ENCRYPTION_SECRET}

      # Password Requirements
      PASSWORD_MIN_LENGTH: ${PASSWORD_MIN_LENGTH}
      PASSWORD_REQUIRE_UPPERCASE: ${PASSWORD_REQUIRE_UPPERCASE}
      PASSWORD_REQUIRE_LOWERCASE: ${PASSWORD_REQUIRE_LOWERCASE}
      PASSWORD_REQUIRE_NUMBERS: ${PASSWORD_REQUIRE_NUMBERS}
      PASSWORD_REQUIRE_SPECIAL_CHARS: ${PASSWORD_REQUIRE_SPECIAL_CHARS}

      # Security Settings
      SECURE_COOKIES: ${SECURE_COOKIES}
      SESSION_TIMEOUT: ${SESSION_TIMEOUT}
      MAX_LOGIN_ATTEMPTS: ${MAX_LOGIN_ATTEMPTS}
      LOCKOUT_DURATION: ${LOCKOUT_DURATION}

      # Email Configuration
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USERNAME: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME}
      EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS}
      SMTP_FROM: ${SMTP_FROM}
      EMAIL_VERIFICATION_ENABLED: ${EMAIL_VERIFICATION_ENABLED}
      EMAIL_VERIFICATION_REQUIRED: ${EMAIL_VERIFICATION_REQUIRED}
      EMAIL_VERIFICATION_EXPIRY_HOURS: ${EMAIL_VERIFICATION_EXPIRY_HOURS}
      EMAIL_VERIFICATION_BASE_URL: ${EMAIL_VERIFICATION_BASE_URL}
      EMAIL_AUTO_LOGIN_AFTER_VERIFICATION: ${EMAIL_AUTO_LOGIN_AFTER_VERIFICATION}
      ENABLE_EMAIL_VERIFICATION: ${ENABLE_EMAIL_VERIFICATION}
      ENABLE_EMAIL_NOTIFICATIONS: ${ENABLE_EMAIL_NOTIFICATIONS}

      # CORS Configuration
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
      CORS_ALLOWED_METHODS: ${CORS_ALLOWED_METHODS}
      CORS_ALLOWED_HEADERS: ${CORS_ALLOWED_HEADERS}
      CORS_EXPOSE_HEADERS: ${CORS_EXPOSE_HEADERS}
      CORS_MAX_AGE: ${CORS_MAX_AGE}

      # Rate Limiting
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED}
      RATE_LIMIT_WINDOW: ${RATE_LIMIT_WINDOW}
      RATE_LIMIT_AUTH_REQUESTS: ${RATE_LIMIT_AUTH_REQUESTS}
      RATE_LIMIT_AUTH_WINDOW: ${RATE_LIMIT_AUTH_WINDOW}
      RATE_LIMIT_TRADING_REQUESTS: ${RATE_LIMIT_TRADING_REQUESTS}
      RATE_LIMIT_TRADING_WINDOW: ${RATE_LIMIT_TRADING_WINDOW}

      # Monitoring & Observability
      ENABLE_METRICS: ${ENABLE_METRICS}
      ENABLE_TRACING: ${ENABLE_TRACING}
      PROMETHEUS_METRICS_ENABLED: ${PROMETHEUS_METRICS_ENABLED}
      METRICS_PORT: ${METRICS_PORT}

      # Feature Flags
      ENABLE_WEBSOCKET: ${ENABLE_WEBSOCKET}
      ENABLE_BLOCKCHAIN_INTEGRATION: ${ENABLE_BLOCKCHAIN_INTEGRATION}
      ENABLE_PUSH_NOTIFICATIONS: ${ENABLE_PUSH_NOTIFICATIONS}
      ENABLE_SMS_NOTIFICATIONS: ${ENABLE_SMS_NOTIFICATIONS}
      ENABLE_MARKET_DYNAMICS: ${ENABLE_MARKET_DYNAMICS}

      # Cache Configuration
      CACHE_TTL_DEFAULT: ${CACHE_TTL_DEFAULT}
      CACHE_TTL_USER_SESSION: ${CACHE_TTL_USER_SESSION}
      CACHE_TTL_MARKET_DATA: ${CACHE_TTL_MARKET_DATA}
      CACHE_TTL_ANALYTICS: ${CACHE_TTL_ANALYTICS}

      # Tokenization Configuration
      TOKENIZATION_KWH_TO_TOKEN_RATIO: ${TOKENIZATION_KWH_TO_TOKEN_RATIO}
      TOKENIZATION_DECIMALS: ${TOKENIZATION_DECIMALS}
      TOKENIZATION_MAX_READING_KWH: ${TOKENIZATION_MAX_READING_KWH}
      TOKENIZATION_AUTO_MINT_ENABLED: ${TOKENIZATION_AUTO_MINT_ENABLED}
      TOKENIZATION_POLLING_INTERVAL_SECS: ${TOKENIZATION_POLLING_INTERVAL_SECS}
      TOKENIZATION_BATCH_SIZE: ${TOKENIZATION_BATCH_SIZE}

      # Oracle Configuration
      PROCESSING_INTERVAL: ${PROCESSING_INTERVAL}
      ENGINEERING_AUTHORITY: ${ENGINEERING_AUTHORITY}

      # REC Configuration
      REC_AUTHORITY_ONLY: ${REC_AUTHORITY_ONLY}
      REC_ISSUING_AUTHORITY: ${REC_ISSUING_AUTHORITY}
      REC_CERTIFICATION_ENABLED: ${REC_CERTIFICATION_ENABLED}
      CARBON_OFFSET_RATE: ${CARBON_OFFSET_RATE}

      # Kafka Configuration
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      KAFKA_TOPIC: ${KAFKA_TOPIC:-meter-readings}
      KAFKA_CONSUMER_GROUP: ${KAFKA_CONSUMER_GROUP:-gridtokenx-apigateway}
      KAFKA_ENABLED: ${KAFKA_ENABLED:-true}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      mailpit:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - gridtokenx-network
    restart: unless-stopped

  # Trading Platform (Next.js)
  trading:
    build:
      context: ./gridtokenx-trading
      dockerfile: Dockerfile
    container_name: gridtokenx-trading
    ports:
      - "${TRADING_PORT}:3000"
    environment:
      NODE_ENV: ${NODE_ENV}
      TZ: ${TZ}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
      NEXT_PUBLIC_SOLANA_RPC_URL: ${NEXT_PUBLIC_SOLANA_RPC_URL}
      NEXT_PUBLIC_PYTH_PRICE_SERVICE_URL: ${NEXT_PUBLIC_PYTH_PRICE_SERVICE_URL}
    networks:
      - gridtokenx-network
    restart: unless-stopped

  # Smart Meter Simulator (Python/FastAPI)
  smartmeter-simulator:
    build:
      context: ./gridtokenx-smartmeter-simulator
      dockerfile: Dockerfile
    container_name: gridtokenx-smartmeter
    ports:
      - "${SMARTMETER_PORT}:8080"
    environment:
      # General Configuration
      TZ: ${TZ}

      # Database Configuration
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}

      # API Gateway Configuration
      API_GATEWAY_URL: ${API_GATEWAY_URL}
      API_KEY: ${API_KEY}

      # InfluxDB Configuration
      INFLUXDB_URL: ${INFLUXDB_URL}
      INFLUXDB_TOKEN: ${INFLUXDB_TOKEN}
      INFLUXDB_ORG: ${INFLUXDB_ORG}
      INFLUXDB_BUCKET: ${INFLUXDB_BUCKET}

      # Kafka Configuration
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      KAFKA_TOPIC: ${KAFKA_TOPIC:-meter-readings}
      KAFKA_ENABLED: ${KAFKA_ENABLED:-true}

      # Simulation Configuration
      SIMULATION_INTERVAL: ${SIMULATION_INTERVAL:-30}
      NUM_METERS: ${NUM_METERS:-20}
      SIMULATION_SPEED_MULTIPLIER: ${SIMULATION_SPEED_MULTIPLIER:-1}

      # Energy Configuration
      SOLAR_PANEL_EFFICIENCY_MIN: ${SOLAR_PANEL_EFFICIENCY_MIN:-0.15}
      SOLAR_PANEL_EFFICIENCY_MAX: ${SOLAR_PANEL_EFFICIENCY_MAX:-0.22}
      BASE_GENERATION_MIN: ${BASE_GENERATION_MIN:-2.0}
      BASE_GENERATION_MAX: ${BASE_GENERATION_MAX:-10.0}
      BASE_CONSUMPTION_MIN: ${BASE_CONSUMPTION_MIN:-1.0}
      BASE_CONSUMPTION_MAX: ${BASE_CONSUMPTION_MAX:-5.0}
      NOISE_FACTOR_MIN: ${NOISE_FACTOR_MIN:-0.05}
      NOISE_FACTOR_MAX: ${NOISE_FACTOR_MAX:-0.15}

      # P2P Trading Configuration
      MIN_SELL_PRICE: ${MIN_SELL_PRICE:-2.5}
      MAX_SELL_PRICE: ${MAX_SELL_PRICE:-4.5}
      MIN_BUY_PRICE: ${MIN_BUY_PRICE:-2.0}
      MAX_BUY_PRICE: ${MAX_BUY_PRICE:-4.0}
      GRID_FEED_IN_RATE: ${GRID_FEED_IN_RATE:-2.2}
      GRID_PURCHASE_RATE: ${GRID_PURCHASE_RATE:-4.5}

      # Weather Simulation
      WEATHER_SUNNY_WEIGHT: ${WEATHER_SUNNY_WEIGHT:-0.4}
      WEATHER_PARTLY_CLOUDY_WEIGHT: ${WEATHER_PARTLY_CLOUDY_WEIGHT:-0.3}
      WEATHER_CLOUDY_WEIGHT: ${WEATHER_CLOUDY_WEIGHT:-0.15}
      WEATHER_OVERCAST_WEIGHT: ${WEATHER_OVERCAST_WEIGHT:-0.1}
      WEATHER_RAINY_WEIGHT: ${WEATHER_RAINY_WEIGHT:-0.05}
      WEATHER_CHANGE_FREQUENCY: ${WEATHER_CHANGE_FREQUENCY:-5}
      RANDOM_SEED: ${RANDOM_SEED:-42}

      # Battery Storage Configuration
      BATTERY_CAPACITY_MIN: ${BATTERY_CAPACITY_MIN:-5.0}
      BATTERY_CAPACITY_MAX: ${BATTERY_CAPACITY_MAX:-20.0}
      BATTERY_EFFICIENCY_MIN: ${BATTERY_EFFICIENCY_MIN:-0.85}
      BATTERY_EFFICIENCY_MAX: ${BATTERY_EFFICIENCY_MAX:-0.95}

      # Meter Type Distribution
      SOLAR_PROSUMER_RATIO: ${SOLAR_PROSUMER_RATIO:-0.4}
      GRID_CONSUMER_RATIO: ${GRID_CONSUMER_RATIO:-0.35}
      HYBRID_PROSUMER_RATIO: ${HYBRID_PROSUMER_RATIO:-0.15}
      BATTERY_STORAGE_RATIO: ${BATTERY_STORAGE_RATIO:-0.1}
    depends_on:
      postgres:
        condition: service_healthy
      apigateway:
        condition: service_started
      kafka:
        condition: service_healthy
    networks:
      - gridtokenx-network
    restart: unless-stopped

  # Prometheus (Metrics Collection)
  prometheus:
    image: prom/prometheus:latest
    container_name: gridtokenx-prometheus
    volumes:
      - ./gridtokenx-apigateway/docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - gridtokenx-network
    restart: unless-stopped

  # Grafana (Visualization)
  grafana:
    image: grafana/grafana:latest
    container_name: gridtokenx-grafana
    volumes:
      - grafana_data:/var/lib/grafana
      - ./gridtokenx-apigateway/docker/grafana/provisioning:/etc/grafana/provisioning
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    networks:
      - gridtokenx-network
    depends_on:
      - prometheus
    restart: unless-stopped

  # Mailpit SMTP Server (Development Email Testing)
  mailpit:
    image: axllent/mailpit:latest
    container_name: gridtokenx-mailpit
    ports:
      - "${MAILPIT_SMTP_PORT}:1025" # SMTP server
      - "${MAILPIT_WEB_PORT}:8025" # Web UI
    environment:
      MP_MAX_MESSAGES: ${MP_MAX_MESSAGES}
      MP_DATABASE: ${MP_DATABASE}
      MP_SMTP_AUTH_ACCEPT_ANY: ${MP_SMTP_AUTH_ACCEPT_ANY}
      MP_SMTP_AUTH_ALLOW_INSECURE: ${MP_SMTP_AUTH_ALLOW_INSECURE}
      TZ: ${TZ}
    volumes:
      - mailpit_data:/data
    networks:
      - gridtokenx-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8025/api/v1/info" ]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  gridtokenx-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  influxdb_data:
  influxdb_config:
  mailpit_data:
  solana_ledger:
  anchor_cache:
  prometheus_data:
  grafana_data:
  kafka_data:
